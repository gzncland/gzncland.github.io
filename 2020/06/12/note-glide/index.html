<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="笔记,Glide,Android," />










<meta name="description" content="总览本文基于Glide 4.9.0版本，通过一个简单的使用例子分析其背后的工作流程：  With：如何感知Context的生命周期 Load：如何构建请求并设置选项 Into：如何执行请求并通知视图进行加载  部分源码十分冗长，标记为&#x2F;&#x2F;...的部分已经经过简化，但还请耐心阅读。">
<meta property="og:type" content="article">
<meta property="og:title" content="Glide笔记">
<meta property="og:url" content="http://z.projectd.in/2020/06/12/note-glide/index.html">
<meta property="og:site_name" content="Project.d">
<meta property="og:description" content="总览本文基于Glide 4.9.0版本，通过一个简单的使用例子分析其背后的工作流程：  With：如何感知Context的生命周期 Load：如何构建请求并设置选项 Into：如何执行请求并通知视图进行加载  部分源码十分冗长，标记为&#x2F;&#x2F;...的部分已经经过简化，但还请耐心阅读。">
<meta property="article:published_time" content="2020-06-12T14:15:51.000Z">
<meta property="article:modified_time" content="2020-07-14T14:54:08.862Z">
<meta property="article:author" content="Zapper">
<meta property="article:tag" content="笔记">
<meta property="article:tag" content="Glide">
<meta property="article:tag" content="Android">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://z.projectd.in/2020/06/12/note-glide/"/>





  <title>Glide笔记 | Project.d</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Project.d</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tag"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://z.projectd.in/2020/06/12/note-glide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zapper">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Project.d">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Glide笔记</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-12T22:15:51+08:00">
                2020-06-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><p>本文基于Glide 4.9.0版本，通过一个简单的使用例子分析其背后的工作流程：</p>
<ul>
<li>With：如何感知Context的生命周期</li>
<li>Load：如何构建请求并设置选项</li>
<li>Into：如何执行请求并通知视图进行加载</li>
</ul>
<p>部分源码十分冗长，标记为<code>//...</code>的部分已经经过简化，但还请耐心阅读。</p>
<a id="more"></a>

<h1 id="With"><a href="#With" class="headerlink" title="With"></a>With</h1><p><code>Glide.with()</code>的大概逻辑如下：</p>
<ol>
<li>初始化Glide；</li>
<li>通过<code>with()</code>方法传入的参数来判断生命周期的使用，并通过一个空的Fragment来感知生命周期；</li>
<li>返回 RequestManager，给接下来的调用创建请求管理。</li>
</ol>
<h2 id="Glide"><a href="#Glide" class="headerlink" title="Glide"></a>Glide</h2><p>首先从<strong>Glide.with(context)</strong>.load(uri).into(view)中的<code>with</code>看起。</p>
<h3 id="with"><a href="#with" class="headerlink" title="#with"></a>#with</h3><p>查看<code>Glide.with</code>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 提供一个静态接口返回其单例，以使用RequestBuilder构建请求并维护Engine，BitmapPool，DiskCache和MemoryCache。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Glide</span> </span>&#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 通过传递Context加载Glide。</span></span><br><span class="line"><span class="comment">	* 使用Context启动的任何请求将仅应用Application级别的选项，并且不会基于Lifecycle事件启动或停止。 </span></span><br><span class="line"><span class="comment">	* 通常，加载应从使用结果的级别开始。如果资源在子Fragment的View中使用，则应用Fragment进行加载。</span></span><br><span class="line"><span class="comment">	* 如果在父Fragment的View中使用资源，则应使用父Fragment加载。 </span></span><br><span class="line"><span class="comment">	* 如果将资源用于Activity中，则应用Activity加载。</span></span><br><span class="line"><span class="comment">	* 此方法适用于将在Fragment或Activity生命周期之外使用的资源（例如在Service中或用于通知缩略图）。</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@NonNull</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestManager <span class="title">with</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> getRetriever(context).get(context);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码目前来看就是根据传入的 Context 取得 RequestManager ，分为两个步骤：</p>
<ol>
<li><code>Glide.getRetriever(Context)</code>获取到 RequestManagerRetriever</li>
<li><code>RequestManagerRetriever.get(Context)</code>取到 RequestManager</li>
</ol>
<blockquote>
<p>retrieve<br>[rɪˈtriːv]<br>动词、名词，意为“ 检索”；</p>
</blockquote>
<p>那么先从<code>Glide.getRetriever(Context)</code>开始查看：</p>
<h3 id="getRetriever"><a href="#getRetriever" class="headerlink" title="#getRetriever"></a>#getRetriever</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Glide</span> </span>&#123;</span><br><span class="line">	<span class="meta">@NonNull</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> RequestManagerRetriever <span class="title">getRetriever</span><span class="params">(@Nullable Context context)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">		<span class="comment">//return get(context).getRequestManagerRetriever(); 代码经过转换</span></span><br><span class="line">    Glide glide = get(context);</span><br><span class="line">    <span class="keyword">return</span> glide.getRequestManagerRetriever();</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> RequestManagerRetriever <span class="title">getRequestManagerRetriever</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.requestManagerRetriever;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>Glide.getRetriever(Context)</code>方法内部调用了<code>Glide.get(Context)</code>获取<code>Glide</code>实例并返回其<code>getRequestManagerRetriever()</code>的返回值。</p>
</li>
<li><p><code>Glide.getRequestManagerRetriever()</code>很简单，返回了成员<code>requestManagerRetriever</code>。返回上一级查看<code>Glide.get(Context)</code>到底执行了什么。</p>
</li>
</ul>
<h3 id="get——获取单例"><a href="#get——获取单例" class="headerlink" title="#get——获取单例"></a>#get——获取单例</h3><p><code>Glide.get(Context)</code>方法逻辑如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Glide</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Glide glide;</span><br><span class="line">	<span class="comment">/** 获取单例 */</span></span><br><span class="line">	<span class="meta">@NonNull</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Glide <span class="title">get</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (glide == <span class="keyword">null</span>) &#123;</span><br><span class="line">			Class var1 = Glide<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">			<span class="keyword">synchronized</span>(Glide<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (glide == <span class="keyword">null</span>) &#123;</span><br><span class="line">					checkAndInitializeGlide(context);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> glide;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是一个很明显的<strong>单例模式</strong>。至于<code>checkAndInitializeGlide(Context)</code>内部到底实现了什么，这里先暂且略过，返回上级看<code>RequestManagerRetriever.get(Context)</code>。</p>
<h2 id="RequestManagerRetriever"><a href="#RequestManagerRetriever" class="headerlink" title="RequestManagerRetriever"></a>RequestManagerRetriever</h2><h3 id="get"><a href="#get" class="headerlink" title="#get"></a>#get</h3><p>查看RequestManagerRetriever源码，发现其<code>get(Context)</code>方法判断了Context的类型去分别调用了不同的<code>get()</code>，如果不在主线程或者直接传进了 Application 的实例则调用<code>getApplicationManager(Context)</code>，先随便选择一个<code>get(Activity)</code>作为分析对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*  用于创建新的 RequestManager 的静态方法的集合，或者从 Activity 和 Fragment 中检索(retrieving)现有的。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestManagerRetriever</span> </span>&#123;</span><br><span class="line">	<span class="meta">@NonNull</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> RequestManager <span class="title">get</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"You cannot start a load on a null Context"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (Util.isOnMainThread() &amp;&amp; !(context <span class="keyword">instanceof</span> Application)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (context <span class="keyword">instanceof</span> FragmentActivity) &#123;<span class="comment">/*...*/</span>&#125; <span class="comment">//代码经过简化</span></span><br><span class="line">				<span class="keyword">if</span> (context <span class="keyword">instanceof</span> Activity) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">this</span>.get((Activity)context);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (context <span class="keyword">instanceof</span> ContextWrapper) &#123;<span class="comment">/*...*/</span>&#125; <span class="comment">//代码经过简化</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.getApplicationManager(context);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@NonNull</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> RequestManager <span class="title">get</span><span class="params">(@NonNull Activity activity)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (Util.isOnBackgroundThread()) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.get(activity.getApplicationContext());</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			assertNotDestroyed(activity);</span><br><span class="line">			FragmentManager fm = activity.getFragmentManager();</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.fragmentGet(activity, fm, (android.app.Fragment)<span class="keyword">null</span>, isActivityVisible(activity));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>get(Activity)</code>先判断当前线程是否处于前台，如果不是则使用 ApplicationContext 重新调用<code>get(Context)</code>方法（然后走<code>getApplicationManager(Context)</code>流程）；如果是，就在 Activity 没有被销毁的情况下，执行<code>fragmentGet(Context, FragmentManager, Fragment boolean)</code>获取返回值返回给上层方法。</p>
<h3 id="getApplicationManager"><a href="#getApplicationManager" class="headerlink" title="#getApplicationManager"></a>#getApplicationManager</h3><p>介于多次出现了<code>getApplicationManager(Context)</code>方法，所以首先看看这个方法里到底做了什么事情：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestManagerRetriever</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> RequestManager applicationManager;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> RequestManagerRetriever.RequestManagerFactory factory;</span><br><span class="line">	<span class="meta">@NonNull</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> RequestManager <span class="title">getApplicationManager</span><span class="params">(@NonNull Context context)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.applicationManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (<span class="keyword">this</span>.applicationManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="comment">//通常情况Fragment或Activity可以处理Pause/Resume事件，但是Application没有这两个事件，所以使用ApplicationLifecycle。</span></span><br><span class="line">					Glide glide = Glide.get(context.getApplicationContext());</span><br><span class="line">					<span class="keyword">this</span>.applicationManager = <span class="keyword">this</span>.factory.build(glide, <span class="keyword">new</span> ApplicationLifecycle(), <span class="keyword">new</span> EmptyRequestManagerTreeNode(), context.getApplicationContext());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.applicationManager;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看起来这里又是一个<strong>单例模式</strong>，从代码可以看出：</p>
<ul>
<li>首先通过一个 RequestManagerFactory 类成员<code>factory</code>来懒加载<code>applicationManager</code>对象；</li>
<li>指定 ApplicationContext 作为 Context 绑定了 Glide 的单例并指明 ApplicationLifecycle；</li>
<li>最后通过<code>factory.build(Glide, Lifecycle, RequestManagerTreeNode, Context)</code>返回名为<code>applicationManager</code>的 RequestManager 。</li>
</ul>
<p>可是这只是猜想，而且<code>factory.build(Glide, Lifecycle, RequestManagerTreeNode, Context)</code>到底做了什么呢？</p>
<h4 id="RequestManagerFactory-build"><a href="#RequestManagerFactory-build" class="headerlink" title="#RequestManagerFactory#build"></a>#RequestManagerFactory#build</h4><p>万万没想到，RequestManagerFactory 是一个接口。而<code>factory</code>由于其 final 特性仅在构造函数中初始化。如果传入<code>null</code>，则会使用默认的<code>DEFAULT_FACTORY</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestManagerRetriever</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Handler handler;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">RequestManagerRetriever</span><span class="params">(@Nullable RequestManagerRetriever.RequestManagerFactory factory)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.factory = factory != <span class="keyword">null</span> ? factory : DEFAULT_FACTORY;</span><br><span class="line">		<span class="keyword">this</span>.handler = <span class="keyword">new</span> Handler(Looper.getMainLooper(), <span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestManagerFactory</span> </span>&#123;</span><br><span class="line">		<span class="meta">@NonNull</span></span><br><span class="line">		<span class="function">RequestManager <span class="title">build</span><span class="params">(@NonNull Glide var1, @NonNull Lifecycle var2, @NonNull RequestManagerTreeNode var3, @NonNull Context var4)</span></span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续查看<code>DEFAULT_FACTORY</code>的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestManagerRetriever</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RequestManagerRetriever.RequestManagerFactory DEFAULT_FACTORY = <span class="keyword">new</span> RequestManagerRetriever.RequestManagerFactory() &#123;</span><br><span class="line">		<span class="meta">@NonNull</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> RequestManager <span class="title">build</span><span class="params">(@NonNull Glide glide, @NonNull Lifecycle lifecycle, @NonNull RequestManagerTreeNode requestManagerTreeNode, @NonNull Context context)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> RequestManager(glide, lifecycle, requestManagerTreeNode, context);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>确实返回了需要的 RequestManager 对象。至于 RequestManager 是什么，这里先暂不关心，返回<code>RequestManagerRetriever.fragmentGet()</code>把表层逻辑先搞清楚。</p>
<h3 id="fragmentGet"><a href="#fragmentGet" class="headerlink" title="#fragmentGet"></a>#fragmentGet</h3><p>可以看到<code>fragmentGet(Context, FragmentManager, Fragment boolean)</code>方法被标记了 Deprecated 注解（应使用<code>supportFragmentGet()</code>），但是不影响分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestManagerRetriever</span> </span>&#123;</span><br><span class="line">	<span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	<span class="meta">@NonNull</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> RequestManager <span class="title">fragmentGet</span><span class="params">(@NonNull Context context, @NonNull FragmentManager fm, @Nullable android.app.Fragment parentHint, <span class="keyword">boolean</span> isParentVisible)</span> </span>&#123;</span><br><span class="line">		RequestManagerFragment current = <span class="keyword">this</span>.getRequestManagerFragment(fm, parentHint, isParentVisible);</span><br><span class="line">		RequestManager requestManager = current.getRequestManager();</span><br><span class="line">		<span class="keyword">if</span> (requestManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">			Glide glide = Glide.get(context);</span><br><span class="line">			requestManager = <span class="keyword">this</span>.factory.build(glide, current.getGlideLifecycle(), current.getRequestManagerTreeNode(), context);</span><br><span class="line">			current.setRequestManager(requestManager);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> requestManager;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据代码来看，首先获取了 RequestManagerFragment ，并从中获取 RequestManager ，如果获取不到，则由<code>factory</code>生成并设置一个新的 RequestManager ，并返回给上层结果。分析<code>RequestManagerRetriever.getRequestManagerFragment()</code>函数看看里面做了什么：</p>
<h3 id="getRequestManagerFragment"><a href="#getRequestManagerFragment" class="headerlink" title="#getRequestManagerFragment"></a>#getRequestManagerFragment</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestManagerRetriever</span> </span>&#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> String FRAGMENT_TAG = <span class="string">"com.bumptech.glide.manager"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ID_REMOVE_FRAGMENT_MANAGER = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">final</span> Map&lt;FragmentManager, RequestManagerFragment&gt; pendingRequestManagerFragments = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">	<span class="meta">@Deprecated</span></span><br><span class="line">	<span class="meta">@NonNull</span></span><br><span class="line">	<span class="function">RequestManagerFragment <span class="title">getRequestManagerFragment</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.getRequestManagerFragment(activity.getFragmentManager(), (android.app.Fragment)<span class="keyword">null</span>, isActivityVisible(activity));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</span><br><span class="line">	<span class="meta">@NonNull</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> RequestManagerFragment <span class="title">getRequestManagerFragment</span><span class="params">( @NonNull <span class="keyword">final</span> android.app.FragmentManager fm, @Nullable android.app.Fragment parentHint, <span class="keyword">boolean</span> isParentVisible)</span> </span>&#123;</span><br><span class="line">		RequestManagerFragment current = (RequestManagerFragment) fm.findFragmentByTag(FRAGMENT_TAG);</span><br><span class="line">		<span class="keyword">if</span> (current == <span class="keyword">null</span>) &#123;</span><br><span class="line">			current = pendingRequestManagerFragments.get(fm);</span><br><span class="line">			<span class="keyword">if</span> (current == <span class="keyword">null</span>) &#123;</span><br><span class="line">				current = <span class="keyword">new</span> RequestManagerFragment();</span><br><span class="line">				current.setParentFragmentHint(parentHint);</span><br><span class="line">				<span class="keyword">if</span> (isParentVisible) &#123;</span><br><span class="line">					current.getGlideLifecycle().onStart();</span><br><span class="line">				&#125;</span><br><span class="line">				pendingRequestManagerFragments.put(fm, current);</span><br><span class="line">				fm.beginTransaction().add(current, FRAGMENT_TAG).commitAllowingStateLoss();</span><br><span class="line">				handler.obtainMessage(ID_REMOVE_FRAGMENT_MANAGER, fm).sendToTarget();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> current;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isActivityVisible</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> !activity.isFinishing();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个代码看似很长，其实只做了<strong>一点微小的工作</strong>，很惭愧：</p>
<ol>
<li>从传入的 FragmentManager 找一个Tag为<code>FRAGMENT_TAG(com.bumptech.glide.manager)</code>的Fragment；</li>
<li>如果没找到，从自己的<code>pendingRequestManagerFragments</code>中找；</li>
<li>还是没找到？新建一个 RequestManagerFragment ，设置Tag为<code>FRAGMENT_TAG</code>，扔进<code>pendingRequestManagerFragments</code>中并将它加入传进来的 FragmentManager 里。如果 Activity 没有 finish 掉，则调用一次生命周期的<code>onStart()</code>方法。</li>
</ol>
<p>如果说还有一点成绩，那就是向<code>handler</code>发送了消息，将 FragmentManager 从<code>pendingRequestManagerFragments</code>中移除：</p>
<h3 id="handleMessage"><a href="#handleMessage" class="headerlink" title="#handleMessage"></a>#handleMessage</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestManagerRetriever</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">boolean</span> handled = <span class="keyword">true</span>;</span><br><span class="line">		Object removed = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">switch</span>(message.what) &#123;</span><br><span class="line">			<span class="keyword">case</span> ID_REMOVE_FRAGMENT_MANAGER:</span><br><span class="line">			android.app.FragmentManager fm = (android.app.FragmentManager) message.obj;</span><br><span class="line">			key = fm;</span><br><span class="line">			removed = pendingRequestManagerFragments.remove(fm);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">			<span class="comment">//...代码已简化</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//...代码已简化</span></span><br><span class="line">		<span class="keyword">return</span> handled;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RequestManagerFragment——感知生命周期"><a href="#RequestManagerFragment——感知生命周期" class="headerlink" title="RequestManagerFragment——感知生命周期"></a>RequestManagerFragment——感知生命周期</h2><p>最后，为什么要添加一个 RequestManagerFragment 呢？查看其源码不难看出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 用于安全存储 RequestManager的无视图Fragment 。</span></span><br><span class="line"><span class="comment">* 可用于启动、停止和管理针对目标Fragment或该Fragment所属的Activity而启动的Glide请求。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"DeprecatedIsStillUsed"</span>)</span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestManagerFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ActivityFragmentLifecycle lifecycle;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RequestManagerFragment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>(<span class="keyword">new</span> ActivityFragmentLifecycle());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@VisibleForTesting</span></span><br><span class="line">    <span class="meta">@SuppressLint</span>(<span class="string">"ValidFragment"</span>)</span><br><span class="line">    RequestManagerFragment(<span class="meta">@NonNull</span> ActivityFragmentLifecycle lifecycle) &#123;</span><br><span class="line">        <span class="keyword">this</span>.lifecycle = lifecycle;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStart();</span><br><span class="line">        lifecycle.onStart();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStop();</span><br><span class="line">        lifecycle.onStop();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        lifecycle.onDestroy();</span><br><span class="line">        unregisterFragmentWithRoot();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RequestManagerFragment 的实际作用是通过附加在父视图上感知父视图的生命周期。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>自此，<code>Glide.with()</code>的大部分逻辑已经理清，最终返回的 RequestManager 即可调用<code>load()</code>方法进行图片的获取。其逻辑可以小结如下：</p>
<ol>
<li>通过<code>Glide.with()</code> &gt; <code>Glide.getRetriever()</code> &gt; <code>Glide.get()</code> &gt; <code>Glide.getRequestManagerRetriever()</code>取得 RequestManagerRetriever；</li>
<li><code>Glide.get()</code>内部调用了<code>Glide.checkAndInitializeGlide()</code>来初始化Glide；</li>
<li>通过<code>RequestManagerRetriever.get()</code>传入的Context取得不同的 RequestManager：如果不是 ApplicationContext 则通过创建 Framgent 等方式感知生命周期。</li>
</ol>
<h1 id="Load"><a href="#Load" class="headerlink" title="Load"></a>Load</h1><p>回到一开始的 Glide.with(context).<strong>load(uri)</strong>.into(view)，从上文我们知道<code>Glide.with(context)</code>最后获得了 RequestManager，那现在开始分析 RequestManager 的<code>load()</code>方法。</p>
<h2 id="RequestManager"><a href="#RequestManager" class="headerlink" title="RequestManager"></a>RequestManager</h2><h3 id="load"><a href="#load" class="headerlink" title="#load"></a>#load</h3><p>以<code>RequestManager.load(String)</code>为例，一次查看三个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 用于管理和启动对Glide的请求的类。</span></span><br><span class="line"><span class="comment">* 可以使用 Activity，Fragment和连接 LifeCycle 事件来智能地停止，启动和重新启动请求。</span></span><br><span class="line"><span class="comment">* Glide.load方法中传入Fragment或Activity以实例化新对象或使用内建的lifecycle处理机制来检索。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestManager</span> </span>&#123;</span><br><span class="line">	/ ** 等效于调用RequestManager.asDrawable()，然后调用RequestBuilde.loadString() */</span><br><span class="line">	<span class="meta">@NonNull</span></span><br><span class="line">	<span class="meta">@CheckResult</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="title">load</span><span class="params">(@Nullable String string)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> asDrawable().load(string);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 尝试使用任何已注册的ResourceDecoder（可解码Drawable的任何子类）加载资源。</span></span><br><span class="line"><span class="comment">	* 默认情况下，返回BitmapDrawable或GifDrawable，但是如果为其他 Drawable 子类注册了其他解码器，也可能返回子类中的任何一个。</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@NonNull</span></span><br><span class="line">	<span class="meta">@CheckResult</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="title">asDrawable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> as(Drawable<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 尝试用任何已注册的ResourceDecoder解码资源*/</span></span><br><span class="line">	<span class="meta">@NonNull</span></span><br><span class="line">	<span class="meta">@CheckResult</span></span><br><span class="line">	<span class="keyword">public</span> &lt;ResourceType&gt; <span class="function">RequestBuilder&lt;ResourceType&gt; <span class="title">as</span><span class="params">(@NonNull Class&lt;ResourceType&gt; resourceClass)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> RequestBuilder&lt;&gt;(glide, <span class="keyword">this</span>, resourceClass, context);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>三个方法大概逻辑如下：</p>
<h4 id="load-String"><a href="#load-String" class="headerlink" title="#load(String)"></a>#load(String)</h4><p>由<code>RequestManager.asDrawable()</code>返回一个<code>RequestBuilder&lt;Drawable&gt;</code>，调用其<code>load(String)方法</code>，可以看出<code>RequestManager.load(String)</code>方法默认返回了 Drawable 的 RequestBuilder 来供我们使用。</p>
<p><em>注意区分<code>RequestBuilder&lt;Drawable&gt;.load(String)</code>和<code>RequestManager.load(String)</code></em>；</p>
<h5 id="asDrawable"><a href="#asDrawable" class="headerlink" title="#asDrawable"></a>#asDrawable</h5><p>对<code>as(Drawable.class)</code>的简单封装。代码中类似的还有<code>asFile()</code>。</p>
<h6 id="as"><a href="#as" class="headerlink" title="#as"></a>#as</h6><p>首先看它的整个函数头：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;ResourceType&gt; RequestBuilder&lt;ResourceType&gt; as(Class&lt;ResourceType&gt;)</span><br></pre></td></tr></table></figure>

<p>看起来很复杂，其实这是一个泛型方法，传入一个<code>T</code>的Class，返回一个<code>RequestBuilder&lt;T&gt;</code>。一个简易的实现示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    RequestManager()&#123;</span><br><span class="line">        <span class="comment">//示例</span></span><br><span class="line">        RequestBuilder&lt;Drawable&gt; a = as(Drawable<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        RequestBuilder&lt;File&gt; b = as(File<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//T 就是 ResourceType，在此使用简易的命名</span></span><br><span class="line">    &lt;T&gt; <span class="function">RequestBuilder&lt;T&gt; <span class="title">as</span><span class="params">(Class&lt;T&gt; clazz)</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> RequestBuilder&lt;&gt;(clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//简易的RequestBuilder类实现</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">RequestBuilder</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">        Class&lt;T&gt; clazz;</span><br><span class="line">        RequestBuilder(Class&lt;T&gt; clazz) &#123;</span><br><span class="line">            <span class="keyword">this</span>.clazz = clazz;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个函数返回一个<code>RequestBuilder&lt;Drawable&gt;</code>类型的变量并传入一些初始化参数，代码中类似的还有<code>as(File.class)</code>，返回<code>RequestBuilder&lt;File&gt;</code>类型变量。那么最主要的应该是<code>RequestBuilder&lt;Drawable&gt;.load(String)</code>方法，接下来前往 RequestBuilder 类分析。</p>
<h2 id="RequestBuilder"><a href="#RequestBuilder" class="headerlink" title="RequestBuilder"></a>RequestBuilder</h2><h3 id="load-1"><a href="#load-1" class="headerlink" title="#load"></a>#load</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 一个可以根据设置处理加载泛型资源的泛型类 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestBuilder</span>&lt;<span class="title">TranscodeType</span>&gt; <span class="keyword">extends</span> <span class="title">BaseRequestOptions</span>&lt;<span class="title">RequestBuilder</span>&lt;<span class="title">TranscodeType</span>&gt;&gt; </span>&#123;</span><br><span class="line">	<span class="meta">@NonNull</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@CheckResult</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">load</span><span class="params">(@Nullable String string)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> loadGeneric(string);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@NonNull</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> RequestBuilder&lt;TranscodeType&gt; <span class="title">loadGeneric</span><span class="params">(@Nullable Object model)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.model = model;</span><br><span class="line">		isModelSet = <span class="keyword">true</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后的<code>RequestBuilder&lt;TranscodeType&gt;.load()</code>比较简单，设置了model之后返回自身，那么<code>load()</code>方法也分析完毕。现在来查看 RequestBuilder 的构造方法：</p>
<h3 id="new"><a href="#new" class="headerlink" title="#new"></a>#new</h3><p>RequestBuilder 的构造方法中根据<code>transcodeClass</code>来指定<code>transitionOptions</code>并调用了<code>apply()</code>方法设置默认的 RequestOptions：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unused"</span>, <span class="string">"WeakerAccess"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestBuilder</span>&lt;<span class="title">TranscodeType</span>&gt; <span class="keyword">extends</span> <span class="title">BaseRequestOptions</span>&lt;<span class="title">RequestBuilder</span>&lt;<span class="title">TranscodeType</span>&gt;&gt; </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> TransitionOptions&lt;?, ? <span class="keyword">super</span> TranscodeType&gt; transitionOptions;</span><br><span class="line">	<span class="meta">@GuardedBy</span>(<span class="string">"this"</span>)</span><br><span class="line">	<span class="keyword">private</span> RequestOptions requestOptions;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@SuppressLint</span>(<span class="string">"CheckResult"</span>)</span><br><span class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"PMD.ConstructorCallsOverridableMethod"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="title">RequestBuilder</span><span class="params">(@NonNull Glide glide, RequestManager requestManager, Class&lt;TranscodeType&gt; transcodeClass, Context context)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.glide = glide;</span><br><span class="line">		<span class="keyword">this</span>.requestManager = requestManager;</span><br><span class="line">		<span class="keyword">this</span>.transcodeClass = transcodeClass;</span><br><span class="line">		<span class="keyword">this</span>.context = context;</span><br><span class="line">		<span class="keyword">this</span>.transitionOptions = requestManager.getDefaultTransitionOptions(transcodeClass);</span><br><span class="line">		<span class="keyword">this</span>.glideContext = glide.getGlideContext();</span><br><span class="line"></span><br><span class="line">		initRequestListeners(requestManager.getDefaultRequestListeners());</span><br><span class="line">		apply(requestManager.getDefaultRequestOptions());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@SuppressLint</span>(<span class="string">"CheckResult"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initRequestListeners</span><span class="params">(List&lt;RequestListener&lt;Object&gt;&gt; requestListeners)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (RequestListener&lt;Object&gt; listener : requestListeners) &#123;</span><br><span class="line">			addListener((RequestListener&lt;TranscodeType&gt;) listener);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="initRequestListeners"><a href="#initRequestListeners" class="headerlink" title="#initRequestListeners"></a>#initRequestListeners</h4><p>首先看 <code>initRequestListeners</code> 其实没什么好说的，加了一个listener，略过；</p>
<h4 id="apply"><a href="#apply" class="headerlink" title="#apply"></a>#apply</h4><p>后面的<code>apply()</code>方法在实际应用中比较常见，处理一些请求的选项，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">RequestOptions options = <span class="keyword">new</span> RequestOptions()</span><br><span class="line">  .centerCrop()</span><br><span class="line">  .placeholder(R.mipmap.placeholder)</span><br><span class="line">  .error(R.mipmap.error)</span><br><span class="line">  .priority(Priority.HIGH)</span><br><span class="line">  .diskCacheStrategy(DiskCacheStrategy.NONE);</span><br><span class="line"></span><br><span class="line">Glide.with(context).load(url).apply(options)</span><br></pre></td></tr></table></figure>

<p>而源码也过于冗长，不在此贴出。</p>
<h4 id="RequestManager-getDefaultTransitionOptions"><a href="#RequestManager-getDefaultTransitionOptions" class="headerlink" title="RequestManager#getDefaultTransitionOptions"></a>RequestManager#getDefaultTransitionOptions</h4><p><code>requestManager.getDefaultTransitionOptions(transcodeClass)</code>方法最后跑进了GlideContext的<code>getDefaultTransitionOptions()</code>方法中获取 TransitionOptions。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestManager</span> </span>&#123;</span><br><span class="line">	<span class="meta">@NonNull</span></span><br><span class="line">	&lt;T&gt; TransitionOptions&lt;?, T&gt; getDefaultTransitionOptions(Class&lt;T&gt; transcodeClass) &#123;</span><br><span class="line">		<span class="keyword">return</span> glide.getGlideContext().getDefaultTransitionOptions(transcodeClass);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那他到底是干什么的，直接查看其源文件：</p>
<h2 id="TransitionOptions——变换选项"><a href="#TransitionOptions——变换选项" class="headerlink" title="TransitionOptions——变换选项"></a>TransitionOptions——变换选项</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一个用于设置当资源加载完成时的 transition 的基类。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TransitionOptions</span>&lt;<span class="title">CHILD</span> <span class="keyword">extends</span> <span class="title">TransitionOptions</span>&lt;<span class="title">CHILD</span>, <span class="title">TranscodeType</span>&gt;, <span class="title">TranscodeType</span>&gt; </span>&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据说明文件很容易能理解，这是一个处理资源加载完成后从占位符(PlaceHolder)或者什么都没有都情况下过渡到目标资源显示的选项类。从<a href="http://bumptech.github.io/glide/doc/transitions.html" target="_blank" rel="noopener">官网的示例</a>也能找到对应代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DrawableCrossFadeFactory factory = <span class="keyword">new</span> DrawableCrossFadeFactory.Builder()</span><br><span class="line">		.setCrossFadeEnabled(<span class="keyword">true</span>)</span><br><span class="line">		.build();</span><br><span class="line"></span><br><span class="line">Glide.with(context).load(url).transition(DrawableTransitionOptions.with(factory));</span><br></pre></td></tr></table></figure>

<h2 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h2><p><code>RequestManager.load</code>方法其实不算复杂，其逻辑小结如下：</p>
<ol>
<li><code>RequestManager.load()</code> 经过 <code>asDrawable().load()</code> &gt; <code>as(Drawable.class).load()</code> &gt; <code>new RequestBuilder&lt;Drawable&gt;.load()</code> 一轮变换取得了对应的 RequestBuilder 以便后面使用；</li>
<li>使用默认的TransitionOptions及RequestOptions来构造 RequestBuilder。</li>
</ol>
<h1 id="Into"><a href="#Into" class="headerlink" title="Into"></a>Into</h1><p>回到 Glide.with(context).load(uri).<strong>into(view)</strong>，从上文我们知道 <code>RequestManager.load()</code> 最后获得了 RequestBuilder，那现在开始分析 RequestBuilder 的<code>into()</code>方法。</p>
<h2 id="RequestBuilder-1"><a href="#RequestBuilder-1" class="headerlink" title="RequestBuilder"></a>RequestBuilder</h2><p>查看<code>into(ImageView)</code>方法，：</p>
<h3 id="into"><a href="#into" class="headerlink" title="#into"></a>#into</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestBuilder</span>&lt;<span class="title">TranscodeType</span>&gt; <span class="keyword">extends</span> <span class="title">BaseRequestOptions</span>&lt;<span class="title">RequestBuilder</span>&lt;<span class="title">TranscodeType</span>&gt;&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> GlideContext glideContext;</span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ViewTarget&lt;ImageView, TranscodeType&gt; <span class="title">into</span><span class="params">(@NonNull ImageView view)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...代码已简化</span></span><br><span class="line">    <span class="keyword">return</span> into(glideContext.buildImageViewTarget(view, transcodeClass), <span class="comment">/*targetListener=*/</span> <span class="keyword">null</span>, requestOptions, Executors.mainThreadExecutor());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RequestBuilder.into()处理了传入的 ImageView ，通过<code>glideContext.buildImageViewTarget(view, transcodeClass)</code>转换成继承<code>Target&lt;TranscodeType&gt;</code>的类型之后内部调用了多次其他重载方法，先一步步分析：</p>
<h4 id="GlideContext-buildImageViewTarget"><a href="#GlideContext-buildImageViewTarget" class="headerlink" title="GlideContext#buildImageViewTarget"></a>GlideContext#buildImageViewTarget</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Glide中所有加载的全局Context，其中包含并公开了加载资源所需的各种注册元素和类。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlideContext</span> <span class="keyword">extends</span> <span class="title">ContextWrapper</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ImageViewTargetFactory imageViewTargetFactory;</span><br><span class="line">	<span class="meta">@NonNull</span></span><br><span class="line">  <span class="keyword">public</span> &lt;X&gt; <span class="function">ViewTarget&lt;ImageView, X&gt; <span class="title">buildImageViewTarget</span><span class="params">(@NonNull ImageView imageView, @NonNull Class&lt;X&gt; transcodeClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> imageViewTargetFactory.buildTarget(imageView, transcodeClass);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>传入ImageView，返回了ViewTarget&lt;ImageView, X&gt;。之前的分析是<code>asDrawable()</code>时构造了RequestBuilder并设置transcodeClass = Drawable.class，继续看<code>ImageViewTargetFactory.buildTarget</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageViewTargetFactory</span> </span>&#123;</span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  <span class="keyword">public</span> &lt;Z&gt; <span class="function">ViewTarget&lt;ImageView, Z&gt; <span class="title">buildTarget</span><span class="params">(@NonNull ImageView view, @NonNull Class&lt;Z&gt; clazz)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Bitmap<span class="class">.<span class="keyword">class</span>.<span class="title">equals</span>(<span class="title">clazz</span>)) </span>&#123;</span><br><span class="line">    	<span class="keyword">return</span> (ViewTarget&lt;ImageView, Z&gt;) <span class="keyword">new</span> BitmapImageViewTarget(view);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Drawable<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)) </span>&#123;</span><br><span class="line">    	<span class="keyword">return</span> (ViewTarget&lt;ImageView, Z&gt;) <span class="keyword">new</span> DrawableImageViewTarget(view);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    	<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unhandled class: "</span> + clazz + <span class="string">", try .as*(Class).transcode(ResourceTranscoder)"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 ImageViewTargetFactory 中，传入Bitmap则返回BitmapImageViewTarget，传入Drawable则返回DrawableImageViewTarget，其他就报错了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestBuilder</span>&lt;<span class="title">TranscodeType</span>&gt; <span class="keyword">extends</span> <span class="title">BaseRequestOptions</span>&lt;<span class="title">RequestBuilder</span>&lt;<span class="title">TranscodeType</span>&gt;&gt; <span class="keyword">implements</span> <span class="title">Cloneable</span>, <span class="title">ModelTypes</span>&lt;<span class="title">RequestBuilder</span>&lt;<span class="title">TranscodeType</span>&gt;&gt; </span>&#123;	</span><br><span class="line">	<span class="meta">@NonNull</span></span><br><span class="line">  <span class="keyword">public</span> &lt;Y extends Target&lt;TranscodeType&gt;&gt; <span class="function">Y <span class="title">into</span><span class="params">(@NonNull Y target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> into(target, <span class="comment">/*targetListener=*/</span> <span class="keyword">null</span>, Executors.mainThreadExecutor());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@Synthetic</span></span><br><span class="line">  &lt;Y extends Target&lt;TranscodeType&gt;&gt; <span class="function">Y <span class="title">into</span><span class="params">(@NonNull Y target,@Nullable RequestListener&lt;TranscodeType&gt; targetListener, Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> into(target, targetListener, <span class="comment">/*options=*/</span> <span class="keyword">this</span>, callbackExecutor);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> &lt;Y extends Target&lt;TranscodeType&gt;&gt; <span class="function">Y <span class="title">into</span><span class="params">(@NonNull Y target, @Nullable RequestListener&lt;TranscodeType&gt; targetListener, BaseRequestOptions&lt;?&gt; options, Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkNotNull(target);</span><br><span class="line">    <span class="comment">//isModelSet 在之前RequestBuilder.loadGeneric()的时候设置成true了</span></span><br><span class="line">    <span class="keyword">if</span> (!isModelSet) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"You must call #load() before calling #into()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Request request = buildRequest(target, targetListener, options, callbackExecutor);</span><br><span class="line"></span><br><span class="line">    Request previous = target.getRequest();</span><br><span class="line">    <span class="keyword">if</span> (request.isEquivalentTo(previous) &amp;&amp; !isSkipMemoryCacheWithCompletePreviousRequest(options, previous)) &#123;</span><br><span class="line">      request.recycle();</span><br><span class="line">      <span class="comment">//如果请求已经完成， 重新开始将确保结果被重新传送，从而触发RequestListeners和Targets。</span></span><br><span class="line">      <span class="comment">//如果请求失败，重新开始将重新启动请求尝试。</span></span><br><span class="line">      <span class="comment">//如果请求已经在运行状态，不管他。</span></span><br><span class="line">      <span class="keyword">if</span> (!Preconditions.checkNotNull(previous).isRunning()) &#123;</span><br><span class="line">        <span class="comment">// 用之前的请求来优化类似于设置占位符、跟踪Targets、获取视图的尺寸等操作。</span></span><br><span class="line">        previous.begin();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    requestManager.clear(target);</span><br><span class="line">    target.setRequest(request);</span><br><span class="line">    requestManager.track(target, request);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不难看出，<code>into()</code>方法首先根据传入参数建立了Request，然后根据之前的请求来比对当前请求，如果相同而且设置了Cache，那么回收当前请求，使用之前的请求，否则对当前请求建立跟踪。现在来看看Request是如何生成的：</p>
<h3 id="buildRequest"><a href="#buildRequest" class="headerlink" title="#buildRequest"></a>#buildRequest</h3><p><code>buildRequest()</code>内部直接调用<code>buildRequestRecursive()</code>如果设置了<code>errorBuilder</code>则生成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestBuilder</span>&lt;<span class="title">TranscodeType</span>&gt; <span class="keyword">extends</span> <span class="title">BaseRequestOptions</span>&lt;<span class="title">RequestBuilder</span>&lt;<span class="title">TranscodeType</span>&gt;&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@Nullable</span> <span class="keyword">private</span> RequestBuilder&lt;TranscodeType&gt; errorBuilder;</span><br><span class="line">	<span class="function"><span class="keyword">private</span> Request <span class="title">buildRequest</span><span class="params">(...)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> buildRequestRecursive(...);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Request <span class="title">buildRequestRecursive</span><span class="params">(...)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如有必要，先构建ErrorRequestCoordinator，以便我们可以更新parentCoordinator。</span></span><br><span class="line">    ErrorRequestCoordinator errorRequestCoordinator = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (errorBuilder != <span class="keyword">null</span>) &#123;</span><br><span class="line">      errorRequestCoordinator = <span class="keyword">new</span> ErrorRequestCoordinator(parentCoordinator);</span><br><span class="line">      parentCoordinator = errorRequestCoordinator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Request mainRequest =</span><br><span class="line">        buildThumbnailRequestRecursive(...);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (errorRequestCoordinator == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> mainRequest;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">//...代码已简化</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为我们在之前也没有设置过<code>errorBuilder</code>，所以直接调用<code>buildThumbnailRequestRecursive()</code>并返回。<code>buildThumbnailRequestRecursive()</code>方法内部如下：</p>
<h3 id="buildThumbnailRequestRecursive"><a href="#buildThumbnailRequestRecursive" class="headerlink" title="#buildThumbnailRequestRecursive"></a>#buildThumbnailRequestRecursive</h3><p>首先判断有没有设置<code>thumbnailBuilder</code>或者<code>thumbSizeMultiplier</code>，如果都没有则走默认情况<code>obtainRequest()</code>，使用<code>SingleRequest.obtain()</code>生成 Request。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestBuilder</span>&lt;<span class="title">TranscodeType</span>&gt; <span class="keyword">extends</span> <span class="title">BaseRequestOptions</span>&lt;<span class="title">RequestBuilder</span>&lt;<span class="title">TranscodeType</span>&gt;&gt; </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">private</span> Request <span class="title">buildThumbnailRequestRecursive</span><span class="params">(...)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (thumbnailBuilder != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">//...代码已简化</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (thumbSizeMultiplier != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">//...代码已简化</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 无缩略图的情况</span></span><br><span class="line">      <span class="keyword">return</span> obtainRequest(...);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Request <span class="title">obtainRequest</span><span class="params">(...)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> SingleRequest.obtain(...);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="SingleRequest"><a href="#SingleRequest" class="headerlink" title="SingleRequest"></a>SingleRequest</h2><h3 id="obtain"><a href="#obtain" class="headerlink" title="#obtain"></a>#obtain</h3><p><code>SingleRequest.obtain()</code>又关联了一个新的类 FactoryPools ，从中获取 Request 出来，然后初始化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">* 一个Request，它将Resource加载到给定的Target中。 </span></span><br><span class="line"><span class="comment">* 参数 &lt;R&gt; ：从加载的资源将被转码的资源的类型。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleRequest</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pools.Pool&lt;SingleRequest&lt;?&gt;&gt; POOL = FactoryPools.threadSafe(<span class="number">150</span>,</span><br><span class="line">      <span class="keyword">new</span> FactoryPools.Factory&lt;SingleRequest&lt;?&gt;&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> SingleRequest&lt;?&gt; create() &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> SingleRequest&lt;Object&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> &lt;R&gt; <span class="function">SingleRequest&lt;R&gt; <span class="title">obtain</span><span class="params">(...)</span> </span>&#123;</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>) </span><br><span class="line">    SingleRequest&lt;R&gt; request = (SingleRequest&lt;R&gt;) POOL.acquire();</span><br><span class="line">    <span class="keyword">if</span> (request == <span class="keyword">null</span>) &#123;</span><br><span class="line">      request = <span class="keyword">new</span> SingleRequest&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    request.init(...);</span><br><span class="line">    <span class="keyword">return</span> request;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(...)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...代码已简化</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="FactoryPools"><a href="#FactoryPools" class="headerlink" title="FactoryPools"></a>FactoryPools</h2><h3 id="threadSafe"><a href="#threadSafe" class="headerlink" title="#threadSafe"></a>#threadSafe</h3><p>可以看到FactoryPools生成的对象池号称永不会返回null，其内部使用SynchronizedPool来维护对象。在<code>SynchronizedPool.acquire()</code>为空的时候调用<code>FactoryPools.Factory.create()</code>来创建新对象并返回。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 提供Pool的实现，永不返回null，在创建新实例时记录日志，并且可以使用FactoryPools.Poolable接口来确保对象在Pool内时不使用。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryPools</span> </span>&#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 返回一个新的线程安全的Pool，该线程永远不会在Pool.acquire()时返回null，</span></span><br><span class="line"><span class="comment">   * 并且包含具有给定最大大小的给定Factory创建的类型的对象。</span></span><br><span class="line"><span class="comment">   * 如果在调用Pool.acquire()时池为空，则将使用给定的Factory创建新实例。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Poolable&gt; <span class="function">Pool&lt;T&gt; <span class="title">threadSafe</span><span class="params">(<span class="keyword">int</span> size, @NonNull Factory&lt;T&gt; factory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> build(<span class="keyword">new</span> SynchronizedPool&lt;T&gt;(size), factory);</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="meta">@NonNull</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> &lt;T extends Poolable&gt; <span class="function">Pool&lt;T&gt; <span class="title">build</span><span class="params">(@NonNull Pool&lt;T&gt; pool, @NonNull Factory&lt;T&gt; factory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> build(pool, factory, FactoryPools.&lt;T&gt;emptyResetter());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Pool&lt;T&gt; <span class="title">build</span><span class="params">(@NonNull Pool&lt;T&gt; pool, @NonNull Factory&lt;T&gt; factory, @NonNull Resetter&lt;T&gt; resetter)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FactoryPool&lt;&gt;(pool, factory, resetter);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryPool</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Pool</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Factory&lt;T&gt; factory;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Resetter&lt;T&gt; resetter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Pool&lt;T&gt; pool;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">acquire</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      T result = pool.acquire();</span><br><span class="line">      <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">        result = factory.create();</span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">          Log.v(TAG, <span class="string">"Created new "</span> + result.getClass());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (result <span class="keyword">instanceof</span> Poolable) &#123;</span><br><span class="line">        ((Poolable) result).getVerifier().setRecycled(<span class="keyword">false</span> <span class="comment">/*isRecycled*/</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后好不容易取到了Request，之后要开始对其进行<code>track()</code>,回到 RequestManager 中：</p>
<h2 id="RequestManager-1"><a href="#RequestManager-1" class="headerlink" title="RequestManager"></a>RequestManager</h2><h3 id="track"><a href="#track" class="headerlink" title="#track"></a>#track</h3><p><code>track()</code>函数将<code>target</code>和<code>request</code>分别加入<code>targetTracker</code>和<code>requestTracker</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestManager</span> </span>&#123;	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> RequestTracker requestTracker;	</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> TargetTracker targetTracker = <span class="keyword">new</span> TargetTracker();</span><br><span class="line">	<span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">track</span><span class="params">(@NonNull Target&lt;?&gt; target, @NonNull Request request)</span> </span>&#123;</span><br><span class="line">    targetTracker.track(target);</span><br><span class="line">    requestTracker.runRequest(request);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestTracker</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runRequest</span><span class="params">(@NonNull Request request)</span> </span>&#123;</span><br><span class="line">    requests.add(request);</span><br><span class="line">      <span class="keyword">if</span> (!isPaused) &#123;</span><br><span class="line">        request.begin();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        request.clear();</span><br><span class="line">        <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</span><br><span class="line">          Log.v(TAG, <span class="string">"Paused, delaying request"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        pendingRequests.add(request);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="SingleRequest-1"><a href="#SingleRequest-1" class="headerlink" title="SingleRequest"></a>SingleRequest</h2><h3 id="begin"><a href="#begin" class="headerlink" title="#begin"></a>#begin</h3><p>以SingleRequest为例，查看其<code>begin()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleRequest</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    assertNotCallingCallbacks();</span><br><span class="line">    stateVerifier.throwIfRecycled();</span><br><span class="line">    startTime = LogTime.getLogTime();</span><br><span class="line">    <span class="keyword">if</span> (model == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)) &#123;</span><br><span class="line">        width = overrideWidth;</span><br><span class="line">        height = overrideHeight;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">int</span> logLevel = getFallbackDrawable() == <span class="keyword">null</span> ? Log.WARN : Log.DEBUG;</span><br><span class="line">      onLoadFailed(<span class="keyword">new</span> GlideException(<span class="string">"Received null model"</span>), logLevel);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status == Status.RUNNING) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot restart a running request"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果我们在完成后重新启动（通常是通过诸如notifyDataSetChanged之类的操作将相同的请求启动到相同的Target或View中），</span></span><br><span class="line">		<span class="comment">// 则可以使用上次获取的资源和大小，而跳过获取新的大小、开始新加载等操作。</span></span><br><span class="line">		<span class="comment">// 这意味着期望View大小更改而需要重新加载的话需要在开始新加载之前明确清除View或Target。</span></span><br><span class="line">    <span class="keyword">if</span> (status == Status.COMPLETE) &#123;</span><br><span class="line">      onResourceReady(resource, DataSource.MEMORY_CACHE);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重新启动既未完成又未运行的请求可以视为新请求，并且可以从头开始再次运行。</span></span><br><span class="line"></span><br><span class="line">    status = Status.WAITING_FOR_SIZE;</span><br><span class="line">    <span class="keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)) &#123;</span><br><span class="line">      onSizeReady(overrideWidth, overrideHeight);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      target.getSize(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((status == Status.RUNNING || status == Status.WAITING_FOR_SIZE) &amp;&amp; canNotifyStatusChanged()) &#123;</span><br><span class="line">      target.onLoadStarted(getPlaceholderDrawable());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (IS_VERBOSE_LOGGABLE) &#123;</span><br><span class="line">      logV(<span class="string">"finished run method in "</span> + LogTime.getElapsedMillis(startTime));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过源码得知，加载时如果已经时Complete的状态，则直接调用回调方法<code>onResourceReady()</code>，否则走<code>onSizeReady()</code>或者调用<code>target.onLoadStarted()</code>。看看两个方法分别实现了什么功能：</p>
<h3 id="onSizeReady-onResourceReady"><a href="#onSizeReady-onResourceReady" class="headerlink" title="#onSizeReady/#onResourceReady"></a>#onSizeReady/#onResourceReady</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleRequest</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Engine engine;</span><br><span class="line">  <span class="keyword">private</span> Target&lt;R&gt; target;</span><br><span class="line">  <span class="comment">/** 永远不要直接调用的回调方法。*/</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">onSizeReady</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">    stateVerifier.throwIfRecycled();</span><br><span class="line">    <span class="keyword">if</span> (IS_VERBOSE_LOGGABLE) &#123;</span><br><span class="line">      logV(<span class="string">"Got onSizeReady in "</span> + LogTime.getElapsedMillis(startTime));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (status != Status.WAITING_FOR_SIZE) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    status = Status.RUNNING;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">float</span> sizeMultiplier = requestOptions.getSizeMultiplier();</span><br><span class="line">    <span class="keyword">this</span>.width = maybeApplySizeMultiplier(width, sizeMultiplier);</span><br><span class="line">    <span class="keyword">this</span>.height = maybeApplySizeMultiplier(height, sizeMultiplier);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (IS_VERBOSE_LOGGABLE) &#123;</span><br><span class="line">      logV(<span class="string">"finished setup for calling load in "</span> + LogTime.getElapsedMillis(startTime));</span><br><span class="line">    &#125;</span><br><span class="line">    loadStatus = engine.load(...); <span class="comment">//这里添加了SingleRequest.this 作为EngieJob的回调</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//这是一个hack，仅对现在测试有效。该加载可以同步完成加载。</span></span><br><span class="line">    <span class="comment">// 主线程之外的任何线程上运行时，加载将异步完成。</span></span><br><span class="line">    <span class="keyword">if</span> (status != Status.RUNNING) &#123;</span><br><span class="line">      loadStatus = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (IS_VERBOSE_LOGGABLE) &#123;</span><br><span class="line">      logV(<span class="string">"finished onSizeReady in "</span> + LogTime.getElapsedMillis(startTime));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/** 永远不要直接调用的回调方法。*/</span></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(Resource&lt;?&gt; resource, DataSource dataSource)</span> </span>&#123;</span><br><span class="line">    stateVerifier.throwIfRecycled();</span><br><span class="line">    loadStatus = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//...代码已简化</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!canSetResource()) &#123;</span><br><span class="line">      releaseResource(resource);</span><br><span class="line">      <span class="comment">// We can't put the status to complete before asking canSetResource().</span></span><br><span class="line">      status = Status.COMPLETE;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    onResourceReady((Resource&lt;R&gt;) resource, (R) received, dataSource);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(Resource&lt;R&gt; resource, R result, DataSource dataSource)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// We must call isFirstReadyResource before setting status.</span></span><br><span class="line">    <span class="keyword">boolean</span> isFirstResource = isFirstReadyResource();</span><br><span class="line">    status = Status.COMPLETE;</span><br><span class="line">    <span class="keyword">this</span>.resource = resource;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...代码已简化</span></span><br><span class="line"></span><br><span class="line">    isCallingCallbacks = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">boolean</span> anyListenerHandledUpdatingTarget = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (requestListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (RequestListener&lt;R&gt; listener : requestListeners) &#123;</span><br><span class="line">          anyListenerHandledUpdatingTarget |=</span><br><span class="line">              listener.onResourceReady(result, model, target, dataSource, isFirstResource);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      anyListenerHandledUpdatingTarget |= targetListener != <span class="keyword">null</span> &amp;&amp; targetListener.onResourceReady(result, model, target, dataSource, isFirstResource);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!anyListenerHandledUpdatingTarget) &#123;</span><br><span class="line">        Transition&lt;? <span class="keyword">super</span> R&gt; animation = animationFactory.build(dataSource, isFirstResource);</span><br><span class="line">        target.onResourceReady(result, animation);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      isCallingCallbacks = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    notifyLoadSuccess();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>onSizeReady()</code>中有一个重要的方法调用：<code>engine.load()</code>；而<code>onResourceReady()</code>中通知了各listener以及<code>target</code>告诉资源已经加载完成。<code>target</code>在Request生成的时候便已经设置进来。还记得<code>SingleRequest.obtain()</code>吗？从<code>RequestBuilder.into()</code>便一路把Target参数传入进来了。</p>
<p>那么<code>onResourceReady()</code>在资源没有加载完成的时候，是谁去加载并调用的呢？猜测是 Engine 类的<code>load()</code>方法，查看之：</p>
<h2 id="Engine"><a href="#Engine" class="headerlink" title="Engine"></a>Engine</h2><h3 id="load——缓存策略"><a href="#load——缓存策略" class="headerlink" title="#load——缓存策略"></a>#load——缓存策略</h3><p><code>load()</code>的源码较长且不好简化，需要耐心解读：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 负责启动负载以及管理活动和缓存的资源。*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Engine</span> <span class="keyword">implements</span> <span class="title">EngineJobListener</span>, <span class="title">MemoryCache</span>.<span class="title">ResourceRemovedListener</span>, <span class="title">EngineResource</span>.<span class="title">ResourceListener</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ActiveResources activeResources;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> EngineKeyFactory keyFactory;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> EngineJobFactory engineJobFactory;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> DecodeJobFactory decodeJobFactory;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Jobs jobs;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 启动给定参数的加载。</span></span><br><span class="line"><span class="comment">   * 必须在主线程上调用。</span></span><br><span class="line"><span class="comment">   * 任何请求的流程如下：</span></span><br><span class="line"><span class="comment">   * 1. 检查当前活动使用的资源集，如果存在则返回活动资源， 并将所有新的非活动资源移到内存缓存中。</span></span><br><span class="line"><span class="comment">   * 2. 检查内存缓存并提供缓存的资源（如果存在）。</span></span><br><span class="line"><span class="comment">   * 3. 检查当前的正在进行中的progress并将cb添加到正在进行中的progress（如果有）。</span></span><br><span class="line"><span class="comment">   * 4. 开始新的加载。</span></span><br><span class="line"><span class="comment">   * 活动资源是指已提供给至少一个请求但尚未释放的资源。一旦资源的所有使用者都释放了该资源，该资源便进入缓存。</span></span><br><span class="line"><span class="comment">   * 如果资源曾经从缓存返回给新的使用者，则将其重新添加到活动资源中。</span></span><br><span class="line"><span class="comment">   * 如果将资源从缓存中拿出，则将对其资源进行回收并在可能的情况下重新使用，并丢弃该资源。</span></span><br><span class="line"><span class="comment">   * 不严格要求消费者释放其资源所以活动的资源为弱应用（不懂翻译正不正确）。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">synchronized</span> &lt;R&gt; <span class="function">LoadStatus <span class="title">load</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      GlideContext glideContext,</span></span></span><br><span class="line"><span class="function"><span class="params">      Object model,</span></span></span><br><span class="line"><span class="function"><span class="params">      Key signature,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">int</span> width,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">int</span> height,</span></span></span><br><span class="line"><span class="function"><span class="params">      Class&lt;?&gt; resourceClass,</span></span></span><br><span class="line"><span class="function"><span class="params">      Class&lt;R&gt; transcodeClass,</span></span></span><br><span class="line"><span class="function"><span class="params">      Priority priority,</span></span></span><br><span class="line"><span class="function"><span class="params">      DiskCacheStrategy diskCacheStrategy,</span></span></span><br><span class="line"><span class="function"><span class="params">      Map&lt;Class&lt;?&gt;, Transformation&lt;?&gt;&gt; transformations,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> isTransformationRequired,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> isScaleOnlyOrNoTransform,</span></span></span><br><span class="line"><span class="function"><span class="params">      Options options,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> isMemoryCacheable,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> useUnlimitedSourceExecutorPool,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> useAnimationPool,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> onlyRetrieveFromCache,</span></span></span><br><span class="line"><span class="function"><span class="params">      ResourceCallback cb,</span></span></span><br><span class="line"><span class="function"><span class="params">      Executor callbackExecutor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> startTime = VERBOSE_IS_LOGGABLE ? LogTime.getLogTime() : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ----------- 1 -----------</span></span><br><span class="line">    EngineKey key = keyFactory.buildKey(model, signature, width, height, transformations,</span><br><span class="line">        resourceClass, transcodeClass, options);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ----------- 2.1 -----------</span></span><br><span class="line">    EngineResource&lt;?&gt; active = loadFromActiveResources(key, isMemoryCacheable);</span><br><span class="line">    <span class="keyword">if</span> (active != <span class="keyword">null</span>) &#123;</span><br><span class="line">      cb.onResourceReady(active, DataSource.MEMORY_CACHE);</span><br><span class="line">      <span class="keyword">if</span> (VERBOSE_IS_LOGGABLE) &#123;</span><br><span class="line">        logWithTimeAndKey(<span class="string">"Loaded resource from active resources"</span>, startTime, key);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ----------- 2.2 -----------</span></span><br><span class="line">    EngineResource&lt;?&gt; cached = loadFromCache(key, isMemoryCacheable);</span><br><span class="line">    <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">      cb.onResourceReady(cached, DataSource.MEMORY_CACHE);</span><br><span class="line">      <span class="keyword">if</span> (VERBOSE_IS_LOGGABLE) &#123;</span><br><span class="line">        logWithTimeAndKey(<span class="string">"Loaded resource from cache"</span>, startTime, key);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ----------- 3 -----------</span></span><br><span class="line">    EngineJob&lt;?&gt; current = jobs.get(key, onlyRetrieveFromCache);</span><br><span class="line">    <span class="keyword">if</span> (current != <span class="keyword">null</span>) &#123;</span><br><span class="line">      current.addCallback(cb, callbackExecutor);</span><br><span class="line">      <span class="keyword">if</span> (VERBOSE_IS_LOGGABLE) &#123;</span><br><span class="line">        logWithTimeAndKey(<span class="string">"Added to existing load"</span>, startTime, key);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> LoadStatus(cb, current);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ----------- 4 -----------</span></span><br><span class="line">    EngineJob&lt;R&gt; engineJob =</span><br><span class="line">        engineJobFactory.build(</span><br><span class="line">            key,</span><br><span class="line">            isMemoryCacheable,</span><br><span class="line">            useUnlimitedSourceExecutorPool,</span><br><span class="line">            useAnimationPool,</span><br><span class="line">            onlyRetrieveFromCache);</span><br><span class="line"></span><br><span class="line">    DecodeJob&lt;R&gt; decodeJob =</span><br><span class="line">        decodeJobFactory.build(</span><br><span class="line">            glideContext,</span><br><span class="line">            model,</span><br><span class="line">            key,</span><br><span class="line">            signature,</span><br><span class="line">            width,</span><br><span class="line">            height,</span><br><span class="line">            resourceClass,</span><br><span class="line">            transcodeClass,</span><br><span class="line">            priority,</span><br><span class="line">            diskCacheStrategy,</span><br><span class="line">            transformations,</span><br><span class="line">            isTransformationRequired,</span><br><span class="line">            isScaleOnlyOrNoTransform,</span><br><span class="line">            onlyRetrieveFromCache,</span><br><span class="line">            options,</span><br><span class="line">            engineJob);</span><br><span class="line"></span><br><span class="line">    jobs.put(key, engineJob);</span><br><span class="line"></span><br><span class="line">    engineJob.addCallback(cb, callbackExecutor);</span><br><span class="line">    engineJob.start(decodeJob); <span class="comment">// &lt;------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (VERBOSE_IS_LOGGABLE) &#123;</span><br><span class="line">      logWithTimeAndKey(<span class="string">"Started new load"</span>, startTime, key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LoadStatus(cb, engineJob);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  <span class="keyword">private</span> EngineResource&lt;?&gt; loadFromActiveResources(Key key, <span class="keyword">boolean</span> isMemoryCacheable) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isMemoryCacheable) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    EngineResource&lt;?&gt; active = activeResources.get(key);</span><br><span class="line">    <span class="keyword">if</span> (active != <span class="keyword">null</span>) &#123;</span><br><span class="line">      active.acquire();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> active;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> EngineResource&lt;?&gt; loadFromCache(Key key, <span class="keyword">boolean</span> isMemoryCacheable) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isMemoryCacheable) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    EngineResource&lt;?&gt; cached = getEngineResourceFromCache(key);</span><br><span class="line">    <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">      cached.acquire();</span><br><span class="line">      activeResources.activate(key, cached);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cached;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol>
<li><code>Engine.load()</code>方法中，<code>keyFactory.buildKey()</code>根据参数组装成一个EngineKey，用于标识此次请求的缓存key；</li>
</ol>
<p>2.1 以这个key去从当前还在激活状态的Resource资源中去寻找，若查找成功则返回；否则进入2.2；</p>
<p>2.2 以key去MemoryCache中去查找，若查找成功则返回并将其激活；否则进入3；</p>
<ol start="3">
<li><p>从<code>jobs</code>中去看是否存在一个已经加载完成或正在加载的EngineJob。若找到，则将回调设置到EngineJob以便接收加载成功或失败的通知；否则进入4</p>
</li>
<li><p>若没有查找到EngineJob，则创建一个EngineJob以及DecodeJob，设置传入的SingleRequest为回调，同时加入到jobs缓存之中，并调用<code>EngineJob.start()</code>方法，触发加载线程执行真正的加载。</p>
</li>
</ol>
<p>显然必须得分析<code>EngineJob.start()</code>方法。</p>
<h3 id="EngineJob-start"><a href="#EngineJob-start" class="headerlink" title="EngineJob#start"></a>EngineJob#start</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EngineJob</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(DecodeJob&lt;R&gt; decodeJob)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.decodeJob = decodeJob;</span><br><span class="line">    GlideExecutor executor = decodeJob.willDecodeFromCache()</span><br><span class="line">        ? diskCacheExecutor</span><br><span class="line">        : getActiveSourceExecutor();</span><br><span class="line">    executor.execute(decodeJob);</span><br><span class="line">  &#125;</span><br><span class="line">   <span class="function"><span class="keyword">private</span> GlideExecutor <span class="title">getActiveSourceExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> useUnlimitedSourceGeneratorPool</span><br><span class="line">        ? sourceUnlimitedExecutor : (useAnimationPool ? animationExecutor : sourceExecutor);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>EngineJob.start()</code>方法很简单，判断当前job是否能从Cache里解码：</p>
<ol>
<li>如果是(从Cache中使用）则使用<code>diskCacheExecutor</code>执行 3，否则执行 2；</li>
<li>调用<code>getActiveSourceExecutor()</code>获取对应的Executor，执行 3；</li>
<li>使用对应Exectuor中的ExecutorService代理执行<code>decodeJob</code>中的<code>run()</code>方法。</li>
</ol>
<h2 id="DecodeJob"><a href="#DecodeJob" class="headerlink" title="DecodeJob"></a>DecodeJob</h2><h3 id="run"><a href="#run" class="headerlink" title="#run"></a>#run</h3><p><code>DecodeJob.run()</code>方法主要捕获了一些异常，在DecodeJob取消或者OOM的时候抛出异常并通知Callback(<code>engineJob</code>)失败，并清理整个DecodeJob。如果<code>run</code>正确地被调用，则应该执行核心方法<code>runWrapped()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 负责从缓存的数据或原始源解码资源，并应用转换和转码的一个类。 */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DecodeJob</span>&lt;<span class="title">R</span>&gt;  </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Object model;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> isCancelled;</span><br><span class="line">  <span class="keyword">private</span> DataFetcher&lt;?&gt; currentFetcher;</span><br><span class="line">  <span class="keyword">private</span> Callback&lt;R&gt; callback;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这里粒度应该更细，但是由于Java的线程池实现会默默地吞噬所有其他致命的异常，因此至少对开发人员而言，这显然会使某些操作失败。</span></span><br><span class="line">    GlideTrace.beginSectionFormat(<span class="string">"DecodeJob#run(model=%s)"</span>, model);</span><br><span class="line">    <span class="comment">// try语句中的方法可能会使currentFetcher无效，因此在此处设置一个局部变量，以确保以任何一种方式清除了fetcher。</span></span><br><span class="line">    DataFetcher&lt;?&gt; localFetcher = currentFetcher;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (isCancelled) &#123;</span><br><span class="line">        notifyFailed();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      runWrapped();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (CallbackException e) &#123;</span><br><span class="line">      <span class="comment">// 如果不受Glide控制的回调引发异常，则应避免以下Glide特定的调试逻辑。</span></span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      <span class="comment">// 捕获Throwable而不是异常以处理OOM。 </span></span><br><span class="line">      <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"DecodeJob threw unexpectedly"</span> + <span class="string">", isCancelled: "</span> + isCancelled + <span class="string">", stage: "</span> + stage, t);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 编码时，我们已经通知了Callback，因此再次通知是不安全的。</span></span><br><span class="line">      <span class="keyword">if</span> (stage != Stage.ENCODE) &#123;</span><br><span class="line">        throwables.add(t);</span><br><span class="line">        notifyFailed();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!isCancelled) &#123;</span><br><span class="line">        <span class="keyword">throw</span> t;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> t;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// 清理 localFetcher</span></span><br><span class="line">      <span class="keyword">if</span> (localFetcher != <span class="keyword">null</span>) &#123;</span><br><span class="line">        localFetcher.cleanup();</span><br><span class="line">      &#125;</span><br><span class="line">      GlideTrace.endSection();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyFailed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    setNotifiedOrThrow();</span><br><span class="line">    GlideException e = <span class="keyword">new</span> GlideException(<span class="string">"Failed to load resource"</span>, <span class="keyword">new</span> ArrayList&lt;&gt;(throwables));</span><br><span class="line">    callback.onLoadFailed(e);</span><br><span class="line">    onLoadFailed();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//当加载由于一个错误或一系列错误而失败时调用。</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onLoadFailed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (releaseManager.onFailed()) &#123;</span><br><span class="line">      releaseInternal();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="runWrapped"><a href="#runWrapped" class="headerlink" title="#runWrapped"></a>#runWrapped</h3><p><code>DecodeJob.runWrapped()</code>方法主要根据了当前的<code>runReason</code>状态来执行相应的操作：</p>
<ol>
<li><code>runReason</code>的初始状态是<code>INITIALIZE</code>，执行<code>getNextStage()</code>方法会根据缓存策略把<code>stage</code>的状态往下走一步，并设置<code>currentGenerator</code>，然后执行<code>runGenerators()</code>；</li>
<li><code>runGenerators()</code>中存在一个循环。如果当前DecodeJob取消、<code>currentGenerator</code>不存在或者<code>currentGenerator.startNext()</code>已经开始了则循环停止。</li>
<li>循环中如果发现<code>stage</code>最后切换到了<code>SOURCE</code>；则将<code>runReason</code>切换到<code>RunReason.SWITCH_TO_SOURCE_SERVICE</code>并请求callback重新运行。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DecodeJob</span>&lt;<span class="title">R</span>&gt;  </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> DataFetcherGenerator currentGenerator;</span><br><span class="line">  <span class="keyword">private</span> RunReason runReason;</span><br><span class="line">  <span class="keyword">private</span> Stage stage;</span><br><span class="line">  <span class="keyword">private</span> Callback&lt;R&gt; callback;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> DecodeHelper&lt;R&gt; decodeHelper = <span class="keyword">new</span> DecodeHelper&lt;&gt;();</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runWrapped</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (runReason) &#123;</span><br><span class="line">      <span class="keyword">case</span> INITIALIZE:</span><br><span class="line">        stage = getNextStage(Stage.INITIALIZE);</span><br><span class="line">        currentGenerator = getNextGenerator();</span><br><span class="line">        runGenerators();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> SWITCH_TO_SOURCE_SERVICE:</span><br><span class="line">        runGenerators();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> DECODE_DATA:</span><br><span class="line">        decodeFromRetrievedData();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unrecognized run reason: "</span> + runReason);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runGenerators</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    currentThread = Thread.currentThread();</span><br><span class="line">    startFetchTime = LogTime.getLogTime();</span><br><span class="line">    <span class="keyword">boolean</span> isStarted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">while</span> (!isCancelled &amp;&amp; currentGenerator != <span class="keyword">null</span> &amp;&amp; !(isStarted = currentGenerator.startNext())) &#123;</span><br><span class="line">      stage = getNextStage(stage);</span><br><span class="line">      currentGenerator = getNextGenerator();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (stage == Stage.SOURCE) &#123;</span><br><span class="line">        reschedule();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 已经用完了stage和enerator，放弃。</span></span><br><span class="line">    <span class="keyword">if</span> ((stage == Stage.FINISHED || isCancelled) &amp;&amp; !isStarted) &#123;</span><br><span class="line">      notifyFailed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成器将开始新的加载，在onDataFetcherReady中对其进行回调。</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reschedule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    runReason = RunReason.SWITCH_TO_SOURCE_SERVICE;</span><br><span class="line">    callback.reschedule(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一些辅助方法：</p>
<ul>
<li>getNextGenerator()：根据当前stage返回对应的DataFetcherGenerator；</li>
<li>getNextStage()：根据不同的策略获取当前Stage的下一个Stage，Stage有以下枚举：<code>INITIALIZE</code>、<code>RESOURCE_CACHE</code>、<code>DATA_CACHE</code>、<code>SOURCE</code>、<code>ENCODE</code>以及<code>FINISHED</code>。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DecodeJob</span>&lt;<span class="title">R</span>&gt;  </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> DecodeHelper&lt;R&gt; decodeHelper = <span class="keyword">new</span> DecodeHelper&lt;&gt;();</span><br><span class="line">  <span class="function"><span class="keyword">private</span> DataFetcherGenerator <span class="title">getNextGenerator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (stage) &#123;</span><br><span class="line">      <span class="keyword">case</span> RESOURCE_CACHE:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResourceCacheGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">      <span class="keyword">case</span> DATA_CACHE:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataCacheGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">      <span class="keyword">case</span> SOURCE:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SourceGenerator(decodeHelper, <span class="keyword">this</span>);</span><br><span class="line">      <span class="keyword">case</span> FINISHED:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unrecognized stage: "</span> + stage);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> Stage <span class="title">getNextStage</span><span class="params">(Stage current)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (current) &#123;</span><br><span class="line">      <span class="keyword">case</span> INITIALIZE:</span><br><span class="line">        <span class="keyword">return</span> diskCacheStrategy.decodeCachedResource()</span><br><span class="line">            ? Stage.RESOURCE_CACHE : getNextStage(Stage.RESOURCE_CACHE);</span><br><span class="line">      <span class="keyword">case</span> RESOURCE_CACHE:</span><br><span class="line">        <span class="keyword">return</span> diskCacheStrategy.decodeCachedData()</span><br><span class="line">            ? Stage.DATA_CACHE : getNextStage(Stage.DATA_CACHE);</span><br><span class="line">      <span class="keyword">case</span> DATA_CACHE:</span><br><span class="line">        <span class="comment">// 如果用户选择仅从缓存中检索资源，则从源跳过加载。</span></span><br><span class="line">        <span class="keyword">return</span> onlyRetrieveFromCache ? Stage.FINISHED : Stage.SOURCE;</span><br><span class="line">      <span class="keyword">case</span> SOURCE:</span><br><span class="line">      <span class="keyword">case</span> FINISHED:</span><br><span class="line">        <span class="keyword">return</span> Stage.FINISHED;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unrecognized stage: "</span> + current);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假设最后使用SourceGenerator进行请求资源的加载。返回到<code>callback</code>设置的地方：<code>Engine.decodeJobFactory.build()</code>，其设置了<code>engineJob</code>为<code>callback</code>，所以返回至Engine类查看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EngineJob</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reschedule</span><span class="params">(DecodeJob&lt;?&gt; job)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 即使在这里取消了作业，仍需要对其进行调度，以便可以自行清理。</span></span><br><span class="line">    getActiveSourceExecutor().execute(job);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到最终还是调用了<code>SourceExecutor().execute()</code> &gt; <code>DecodeJob.run()</code> &gt; <code>DecodeJob.runWrapped()</code>，很显然又会进入到循环中。那么如何打断这个循环让DecodeJob正常结束？来看看<code>currentGenerator.startNext()</code>方法。这里假定使用了最后的 SourceGenerator 来当作<code>currentGenerator</code>：</p>
<h2 id="SourceGenerator"><a href="#SourceGenerator" class="headerlink" title="SourceGenerator"></a>SourceGenerator</h2><h3 id="startNext"><a href="#startNext" class="headerlink" title="#startNext"></a>#startNext</h3><p>这个方法首先判断了是否有可以缓存的数据，如果有则将它写入。当然首次进入的时候肯定是空的，跳过后是另一个判断<code>sourceCacheGenerator</code>，这时候<code>sourceCacheGenerator</code>也是空的，直接进入while循环：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">* 使用已注册的 ModelLoaders 和为负载提供的模型，从原始源数据生成 DataFetchers。</span></span><br><span class="line"><span class="comment">* 根据磁盘缓存策略，可以先将源数据写入磁盘，然后再从缓存文件加载而不是直接返回。 </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SourceGenerator</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> ModelLoader.LoadData&lt;?&gt; loadData;</span><br><span class="line">  <span class="keyword">private</span> DataCacheGenerator sourceCacheGenerator;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">startNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (dataToCache != <span class="keyword">null</span>) &#123;</span><br><span class="line">      Object data = dataToCache;</span><br><span class="line">      dataToCache = <span class="keyword">null</span>;</span><br><span class="line">      cacheData(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sourceCacheGenerator != <span class="keyword">null</span> &amp;&amp; sourceCacheGenerator.startNext()) &#123; <span class="keyword">return</span> <span class="keyword">true</span>; &#125;</span><br><span class="line">    </span><br><span class="line">    sourceCacheGenerator = <span class="keyword">null</span>;</span><br><span class="line">    loadData = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">while</span> (!started &amp;&amp; hasNextModelLoader()) &#123;</span><br><span class="line">      loadData = helper.getLoadData().get(loadDataListIndex++);</span><br><span class="line">      <span class="keyword">if</span> (loadData != <span class="keyword">null</span></span><br><span class="line">          &amp;&amp; (helper.getDiskCacheStrategy().isDataCacheable(loadData.fetcher.getDataSource())</span><br><span class="line">          || helper.hasLoadPath(loadData.fetcher.getDataClass()))) &#123;</span><br><span class="line">        started = <span class="keyword">true</span>;</span><br><span class="line">        loadData.fetcher.loadData(helper.getPriority(), <span class="keyword">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> started;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasNextModelLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> loadDataListIndex &lt; helper.getLoadData().size();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>循环中主要都是DecoderHelper中的处理。直到<code>started</code>变量被标记为<code>true</code>，或者ModelLoader用尽，然后返回是否已经开始。</p>
<p><code>loadData.fetcher.loadData(helper.getPriority(), this);</code>这句比较关键，但是现在只能先查看DecoderHelper 的实现搞清楚逻辑先。</p>
<p>DecoderHelper代码如下：</p>
<h2 id="DecoderHelper"><a href="#DecoderHelper" class="headerlink" title="DecoderHelper"></a>DecoderHelper</h2><h3 id="getLoadData"><a href="#getLoadData" class="headerlink" title="#getLoadData"></a>#getLoadData</h3><p><code>getLoadData()</code>方法涉及到GlideContext中注册的Models，这里<code>getRegistry().getModelLoaders(model)</code>涉及地方太多，只需要知道最后取出的是DataUrlLoader 即可。DataUrlLoader 是在Glide的构造函数中注册的，源码太冗长不在赘述。那么这个方法大意如下：</p>
<ol>
<li>如果<code>isLoadDataSet</code>标识为<code>false</code>，则从<code>glideContext.getRegistry()</code>中注册的ModelLoaders中传入现在的Model寻找对应的ModelLoaders。</li>
<li>这里我们示例的<code>model</code>是 String 类型的 URL 地址，在Glide构造函数中注册为 DataUrlLoader / StringLoader ，但是DataUrlLoader 只能处理开头为<code>data:image</code>的 Url ，所以就返回了 StringLoader 进行<code>buildLoadData()</code></li>
<li>如果<code>buildLoadData</code>成功，添加其进<code>loadData</code>并返回给外部调用（见<code>SourceGenerator.startNext</code>中的<code>helper.getLoadData().get(loadDataListIndex++)</code>）。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DecodeHelper</span>&lt;<span class="title">Transcode</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> isLoadDataSet;</span><br><span class="line">	List&lt;LoadData&lt;?&gt;&gt; getLoadData() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isLoadDataSet) &#123;</span><br><span class="line">      isLoadDataSet = <span class="keyword">true</span>;</span><br><span class="line">      loadData.clear();</span><br><span class="line">      List&lt;ModelLoader&lt;Object, ?&gt;&gt; modelLoaders = glideContext.getRegistry().getModelLoaders(model);</span><br><span class="line">      <span class="comment">//使用 for i 而不用 foreach 提高性能</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = modelLoaders.size(); i &lt; size; i++) &#123;</span><br><span class="line">        ModelLoader&lt;Object, ?&gt; modelLoader = modelLoaders.get(i);</span><br><span class="line">        LoadData&lt;?&gt; current = modelLoader.buildLoadData(model, width, height, options);</span><br><span class="line">        <span class="keyword">if</span> (current != <span class="keyword">null</span>) &#123;</span><br><span class="line">          loadData.add(current);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> loadData;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="ModelLoader"><a href="#ModelLoader" class="headerlink" title="ModelLoader"></a>ModelLoader</h2><h3 id="StringLoader"><a href="#StringLoader" class="headerlink" title="StringLoader"></a>StringLoader</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 用于处理某些字符串模型的模型Loader。 使用ContentResolver.openInputStream（Uri）&#125;处理的方案处理路径，URL和任何uri字符串。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringLoader</span>&lt;<span class="title">Data</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ModelLoader&lt;Uri, Data&gt; uriLoader;</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">LoadData</span>&lt;<span class="title">Data</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> DataFetcher&lt;Data&gt; fetcher;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> LoadData&lt;Data&gt; <span class="title">buildLoadData</span><span class="params">(@NonNull String model, <span class="keyword">int</span> width, <span class="keyword">int</span> height, @NonNull Options options)</span> </span>&#123;</span><br><span class="line">    Uri uri = parseUri(model);</span><br><span class="line">    <span class="keyword">if</span> (uri == <span class="keyword">null</span> || !uriLoader.handles(uri)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> uriLoader.buildLoadData(uri, width, height, options);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handles</span><span class="params">(@NonNull String model)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 避免两次解析Uri，如果我们不处理这种特定的Uri类型，则只需从buildLoadData返回null即可。</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>StringLoader 中有一个成员变量<code>uriLoader</code>，他在Glide注册的时候是一个MultiModelLoader类型，他的<code>buildLoadData</code>有以下步骤：</p>
<ol>
<li><p>从注册的ModelLoader选择能<code>handle()</code>传入的model，如果一个ModelLoader能正确的操作传入的model，则调用其<code>buildLoadData()</code>方法创建ModelLoadel.LoadData。<code>StringLoader.uriLoader</code>其中名为<code>HttpUrlLoader</code>的ModelLoader能正确操作String的URL地址（其内部又有HttpGlideUrlLoader），所以使用他创建。调用堆栈如下（反向）：</p>
<ul>
<li>StringLoader.buildLoadData()</li>
<li>MultiModelLoader.buildLoadData()</li>
<li>HttpUrlLoader.buildLoadData()</li>
<li>HttpGlideLoader.buildLoadData()</li>
</ul>
</li>
<li><p>最后HttpGlideLoader返回了带有HttpUrlFetcher的ModelLoader.LoadData，然后在MultiModelLoader中加入刚才的HttpUrlFetcher，组成新的ModelLoader.LoadData往上传；</p>
</li>
<li><p>返回一个ModelLoader.LoadData，而<code>uriLoader</code>的成员<code>fetcher</code>自然也就是MultiFetcher。MultiFetcher中又有刚才传的HttpUrlFetcher。层层引用，极为复杂。</p>
</li>
</ol>
<p>所以<code>DecodeHelper.modelLoader.buildLoadData</code>实际上是<code>DecodeHelper.modelLoader.uriLoader.fetcher.fetchers.get(index).loadData()</code>。最后直接看HttpUrlFetcher就好了。</p>
<h2 id="HttpUrlFetcher"><a href="#HttpUrlFetcher" class="headerlink" title="HttpUrlFetcher"></a>HttpUrlFetcher</h2><h3 id="loadDataWithRedirects——网络连接"><a href="#loadDataWithRedirects——网络连接" class="headerlink" title="#loadDataWithRedirects——网络连接"></a>#loadDataWithRedirects——网络连接</h3><p>终于来到了访问网络的地方，可算不容易！其实也没有什么神秘之处，使用HttpURLConnection，并处理一些常见错误，成功后就转换取到InputSteam，最后调用Callback的 <code>onDataReady()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 一个DataFetcher，它为url获取InputStream。 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpUrlFetcher</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadData</span><span class="params">(@NonNull Priority priority, @NonNull DataCallback&lt;? <span class="keyword">super</span> InputStream&gt; callback)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    InputStream result = loadDataWithRedirects(glideUrl.toURL(), <span class="number">0</span>, <span class="keyword">null</span>, glideUrl.getHeaders());</span><br><span class="line">    callback.onDataReady(result);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> InputStream <span class="title">loadDataWithRedirects</span><span class="params">(URL url, <span class="keyword">int</span> redirects, URL lastUrl, Map&lt;String, String&gt; headers)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    urlConnection = connectionFactory.build(url);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 显式连接以避免连接失败时的错误。</span></span><br><span class="line">    urlConnection.connect();</span><br><span class="line">    <span class="comment">// 设置InputStream，以便在清理时将其关闭以避免资源泄漏。 参见＃2352。</span></span><br><span class="line">    stream = urlConnection.getInputStream();</span><br><span class="line">    <span class="keyword">if</span> (isCancelled) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> statusCode = urlConnection.getResponseCode();</span><br><span class="line">    <span class="keyword">if</span> (isHttpOk(statusCode)) &#123;</span><br><span class="line">      <span class="keyword">return</span> getStreamForSuccessfulRequest(urlConnection);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isHttpRedirect(statusCode)) &#123;</span><br><span class="line">      String redirectUrlString = urlConnection.getHeaderField(<span class="string">"Location"</span>);</span><br><span class="line">      <span class="keyword">if</span> (TextUtils.isEmpty(redirectUrlString)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="string">"Received empty or null redirect url"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      URL redirectUrl = <span class="keyword">new</span> URL(url, redirectUrlString);</span><br><span class="line">      <span class="comment">// 除了断开下面的url连接之外，还特别需要关闭InputStream，以避免泄漏ResponseBody。 参见＃2352。</span></span><br><span class="line">      cleanup();</span><br><span class="line">      <span class="keyword">return</span> loadDataWithRedirects(redirectUrl, redirects + <span class="number">1</span>, url, headers);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2XX OK </span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isHttpOk</span><span class="params">(<span class="keyword">int</span> statusCode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> statusCode / <span class="number">100</span> == <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3XX 重定向</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isHttpRedirect</span><span class="params">(<span class="keyword">int</span> statusCode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> statusCode / <span class="number">100</span> == <span class="number">3</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">private</span> InputStream <span class="title">getStreamForSuccessfulRequest</span><span class="params">(HttpURLConnection urlConnection)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(urlConnection.getContentEncoding())) &#123;</span><br><span class="line">      <span class="keyword">int</span> contentLength = urlConnection.getContentLength();</span><br><span class="line">      stream = ContentLengthInputStream.obtain(urlConnection.getInputStream(), contentLength);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">      stream = urlConnection.getInputStream();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> stream;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么callback是谁呢？答案是之前的MultiModelLoader.MultiFetcher。在<code>HttpUrlFetcher.loadData(helper.getPriority(), this);</code>方法执行时将自己传进来了，并且存在很多的链锁回调（回调地狱？！），堆栈如下（正向）：</p>
<ol>
<li>MultiModelLoader.MultiFetcher.onDataReady()；</li>
<li>SourceGenerator.onDataReady()；在这个回调中，如果设置了Cache策略，将会把图片缓存然后重新执行一遍DecodeJob（这时候就会从本地取），会指向<code>onDataFetcherReady()</code>。</li>
<li>DecodeJob.onDataFetcherReady()；在这里如果不是当前线程，则会请求重新运行这个job；如果是，则调用<code>decodeFromRetrievedData()</code>方法进行显示。</li>
</ol>
<p>重新回到DecodeJob，看看<code>decodeFromRetrievedData()</code>：</p>
<h2 id="DecodeJob-1"><a href="#DecodeJob-1" class="headerlink" title="DecodeJob"></a>DecodeJob</h2><h3 id="decodeFromRetrievedData"><a href="#decodeFromRetrievedData" class="headerlink" title="#decodeFromRetrievedData"></a>#decodeFromRetrievedData</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DecodeJob</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDataFetcherReady</span><span class="params">(Key sourceKey, Object data, DataFetcher&lt;?&gt; fetcher,</span></span></span><br><span class="line"><span class="function"><span class="params">      DataSource dataSource, Key attemptedKey)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != currentThread) &#123;</span><br><span class="line">      runReason = RunReason.DECODE_DATA;</span><br><span class="line">      callback.reschedule(<span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      GlideTrace.beginSection(<span class="string">"DecodeJob.decodeFromRetrievedData"</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        decodeFromRetrievedData();</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        GlideTrace.endSection();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">decodeFromRetrievedData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Resource&lt;R&gt; resource = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    resource = decodeFromData(currentFetcher, currentData, currentDataSource);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span> (resource != <span class="keyword">null</span>) &#123;</span><br><span class="line">      notifyEncodeAndRelease(resource, currentDataSource);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      runGenerators();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> &lt;Data&gt; <span class="function">Resource&lt;R&gt; <span class="title">decodeFromData</span><span class="params">(DataFetcher&lt;?&gt; fetcher, Data data,  DataSource dataSource)</span> <span class="keyword">throws</span> GlideException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">      Resource&lt;R&gt; result = decodeFromFetcher(data, dataSource);</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      fetcher.cleanup();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> &lt;Data&gt; <span class="function">Resource&lt;R&gt; <span class="title">decodeFromFetcher</span><span class="params">(Data data, DataSource dataSource)</span> <span class="keyword">throws</span> GlideException </span>&#123;</span><br><span class="line">    LoadPath&lt;Data, ?, R&gt; path = decodeHelper.getLoadPath((Class&lt;Data&gt;) data.getClass());</span><br><span class="line">    <span class="keyword">return</span> runLoadPath(data, dataSource, path);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> &lt;Data, ResourceType&gt; <span class="function">Resource&lt;R&gt; <span class="title">runLoadPath</span><span class="params">(Data data, DataSource dataSource, LoadPath&lt;Data, ResourceType, R&gt; path)</span> <span class="keyword">throws</span> GlideException </span>&#123;</span><br><span class="line">    Options options = getOptionsWithHardwareConfig(dataSource);</span><br><span class="line">    DataRewinder&lt;Data&gt; rewinder = glideContext.getRegistry().getRewinder(data);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 下面的DecodeCallback中的ResourceType是进行gradle编译所必需的。</span></span><br><span class="line">      <span class="keyword">return</span> path.load(rewinder, options, width, height, <span class="keyword">new</span> DecodeCallback&lt;ResourceType&gt;(dataSource));</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      rewinder.cleanup();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还是老味道，一层套一层，没有什么特别核心的部分，粗略跳过：</p>
<ol>
<li>首先<code>decodeFromData()</code>外边套try，然后根据结果分支；</li>
<li><code>decodeFromData()</code>里面记录时间，然后进入<code>decodeFromFetcher()</code>；</li>
<li><code>decodeFromFetcher</code>又通过 DecoderHelper 获取了 LoadPath ，最后<code>runLoadPath()</code>，调用<code>path</code>的<code>load</code>方法。</li>
</ol>
<p>首先看本类的<code>notifyEncodeAndRelease()</code>：</p>
<h3 id="notifyEncodeAndRelease"><a href="#notifyEncodeAndRelease" class="headerlink" title="#notifyEncodeAndRelease"></a>#notifyEncodeAndRelease</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DecodeJob</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyEncodeAndRelease</span><span class="params">(Resource&lt;R&gt; resource, DataSource dataSource)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (resource <span class="keyword">instanceof</span> Initializable) &#123;</span><br><span class="line">      ((Initializable) resource).initialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Resource&lt;R&gt; result = resource;</span><br><span class="line">    LockedResource&lt;R&gt; lockedResource = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (deferredEncodeManager.hasResourceToEncode()) &#123;</span><br><span class="line">      lockedResource = LockedResource.obtain(resource);</span><br><span class="line">      result = lockedResource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    notifyComplete(result, dataSource);</span><br><span class="line"></span><br><span class="line">    stage = Stage.ENCODE;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (deferredEncodeManager.hasResourceToEncode()) &#123;</span><br><span class="line">        deferredEncodeManager.encode(diskCacheProvider, options);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (lockedResource != <span class="keyword">null</span>) &#123;</span><br><span class="line">        lockedResource.unlock();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在finally块之外调用onEncodeComplete，以便在编码过程抛出异常时不调用。</span></span><br><span class="line">    onEncodeComplete();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyComplete</span><span class="params">(Resource&lt;R&gt; resource, DataSource dataSource)</span> </span>&#123;</span><br><span class="line">    setNotifiedOrThrow();</span><br><span class="line">    callback.onResourceReady(resource, dataSource);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>notifyComplete()</code></li>
<li><code>deferredEncodeManager.encode()</code></li>
<li><code>callback.onResourceReady()</code></li>
</ol>
<p>根据上面分析我们可以知道，<code>callback</code>是EngineJob的一个实例（<code>Engine#load</code>)，但是我们的“Resource”怎么“Ready”的还没有搞清楚，所以先看看<code>path.load(rewinder, options, width, height, new DecodeCallback&lt;ResourceType&gt;(dataSource))</code>中的LoadPath</p>
<h2 id="LoadPath"><a href="#LoadPath" class="headerlink" title="LoadPath"></a>LoadPath</h2><h3 id="load-2"><a href="#load-2" class="headerlink" title="#load"></a>#load</h3><p>Load 方法就是从多个DecodePath中获取数据。直接分析DecodePath就行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对于给定DataFetcher的类，通过一个或多个DecodePath尝试获取数据。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadPath</span>&lt;<span class="title">Data</span>, <span class="title">ResourceType</span>, <span class="title">Transcode</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Resource&lt;Transcode&gt; <span class="title">load</span><span class="params">(...)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> loadWithExceptionList(rewinder, options, width, height, decodeCallback, throwables);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      listPool.release(throwables);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Resource&lt;Transcode&gt; <span class="title">loadWithExceptionList</span><span class="params">(...)</span> </span>&#123;</span><br><span class="line">    Resource&lt;Transcode&gt; result = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//使用fori提升性能</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = decodePaths.size(); i &lt; size; i++) &#123;</span><br><span class="line">      DecodePath&lt;Data, ResourceType, Transcode&gt; path = decodePaths.get(i);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        result = path.decode(rewinder, width, height, options, decodeCallback);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (GlideException e) &#123;</span><br><span class="line">        exceptions.add(e);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="DecodePath"><a href="#DecodePath" class="headerlink" title="DecodePath"></a>DecodePath</h2><h3 id="decode"><a href="#decode" class="headerlink" title="#decode"></a>#decode</h3><p>可惜这里也没什么好看的，直接抛出结论好了：尝试从给定的数据类型解码和转码资源类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**尝试从给定的数据类型解码和转码资源类型*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DecodePath</span>&lt;<span class="title">DataType</span>, <span class="title">ResourceType</span>, <span class="title">Transcode</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ResourceTranscoder&lt;ResourceType, Transcode&gt; transcoder;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Resource&lt;Transcode&gt; <span class="title">decode</span><span class="params">(DataRewinder&lt;DataType&gt; rewinder, <span class="keyword">int</span> width, <span class="keyword">int</span> height,</span></span></span><br><span class="line"><span class="function"><span class="params">      @NonNull Options options, DecodeCallback&lt;ResourceType&gt; callback)</span> <span class="keyword">throws</span> GlideException </span>&#123;</span><br><span class="line">    Resource&lt;ResourceType&gt; decoded = decodeResource(rewinder, width, height, options);</span><br><span class="line">    Resource&lt;ResourceType&gt; transformed = callback.onResourceDecoded(decoded);</span><br><span class="line">    <span class="keyword">return</span> transcoder.transcode(transformed, options);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">private</span> Resource&lt;ResourceType&gt; <span class="title">decodeResource</span><span class="params">(DataRewinder&lt;DataType&gt; rewinder, <span class="keyword">int</span> width,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">int</span> height, @NonNull Options options)</span> <span class="keyword">throws</span> GlideException </span>&#123;</span><br><span class="line">    List&lt;Throwable&gt; exceptions = Preconditions.checkNotNull(listPool.acquire());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> decodeResourceWithList(rewinder, width, height, options, exceptions);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      listPool.release(exceptions);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Resource&lt;ResourceType&gt; <span class="title">decodeResourceWithList</span><span class="params">(...)</span> </span>&#123;</span><br><span class="line">    Resource&lt;ResourceType&gt; result = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//noinspection ForLoopReplaceableByForEach to improve perf</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = decoders.size(); i &lt; size; i++) &#123;</span><br><span class="line">      ResourceDecoder&lt;DataType, ResourceType&gt; decoder = decoders.get(i);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        DataType data = rewinder.rewindAndGet();</span><br><span class="line">        <span class="keyword">if</span> (decoder.handles(data, options)) &#123;</span><br><span class="line">          data = rewinder.rewindAndGet();</span><br><span class="line">          result = decoder.decode(data, width, height, options);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; </span><br><span class="line">      <span class="comment">//...省略catch</span></span><br><span class="line">      <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>现在“Resource”已经“Ready”。回到EngineJob中分析：</p>
<h2 id="EngineJob"><a href="#EngineJob" class="headerlink" title="EngineJob"></a>EngineJob</h2><h3 id="onResourceReady"><a href="#onResourceReady" class="headerlink" title="#onResourceReady"></a>#onResourceReady</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EngineJob</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(Resource&lt;R&gt; resource, DataSource dataSource)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.resource = resource;</span><br><span class="line">      <span class="keyword">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    notifyCallbacksOfResult();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Synthetic</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">notifyCallbacksOfResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ResourceCallbacksAndExecutors copy;</span><br><span class="line">    Key localKey;</span><br><span class="line">    EngineResource&lt;?&gt; localResource;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">      stateVerifier.throwIfRecycled();</span><br><span class="line">      <span class="keyword">if</span> (isCancelled) &#123;</span><br><span class="line">        resource.recycle();</span><br><span class="line">        release();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cbs.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Received a resource without any callbacks to notify"</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hasResource) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already have resource"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      engineResource = engineResourceFactory.build(resource, isCacheable);</span><br><span class="line">      <span class="comment">//在下面的回调期间保留资源，因此在通知某个回调是否已同步释放它的过程中，我们不会对其进行回收。</span></span><br><span class="line">			<span class="comment">//在这里用锁获取它，这样在调用下一个回调之前，在下面的下一个锁定部分之前执行的所有新添加的回调都无法回收资源。</span></span><br><span class="line">      hasResource = <span class="keyword">true</span>;</span><br><span class="line">      copy = cbs.copy();</span><br><span class="line">      incrementPendingCallbacks(copy.size() + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">      localKey = key;</span><br><span class="line">      localResource = engineResource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    listener.onEngineJobComplete(<span class="keyword">this</span>, localKey, localResource);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> ResourceCallbackAndExecutor entry : copy) &#123;</span><br><span class="line">      entry.executor.execute(<span class="keyword">new</span> CallResourceReady(entry.cb));</span><br><span class="line">    &#125;</span><br><span class="line">    decrementPendingCallbacks();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到最后又去调用了<code>entry</code>去执行<code>entry.cb</code>。而<code>entry</code>是<code>cbs</code>引用的拷贝<code>copy</code>，<code>cbs</code>就是之前<code>EngitJob#load</code>方法中传入的SingleRequest实例。</p>
<p><code>entry.executor.execute(new CallResourceReady(entry.cb));</code>绕了一大圈回来会调用<code>SingleRequest#onResourceReady</code>，直接查看就好了。</p>
<h2 id="SingleRequest-2"><a href="#SingleRequest-2" class="headerlink" title="SingleRequest"></a>SingleRequest</h2><h3 id="onResourceReady-1"><a href="#onResourceReady-1" class="headerlink" title="#onResourceReady"></a>#onResourceReady</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleRequest</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> List&lt;RequestListener&lt;R&gt;&gt; requestListeners;</span><br><span class="line">  <span class="keyword">private</span> RequestListener&lt;R&gt; targetListener;</span><br><span class="line">  <span class="keyword">private</span> Target&lt;R&gt; target;</span><br><span class="line">  <span class="keyword">private</span> Object model;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(Resource&lt;?&gt; resource, DataSource dataSource)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...省略了检查参数代码</span></span><br><span class="line">    <span class="keyword">if</span> (!canSetResource()) &#123;</span><br><span class="line">      releaseResource(resource);</span><br><span class="line">      <span class="comment">// 在canSetResource之前不能把状态设置成完成.</span></span><br><span class="line">      status = Status.COMPLETE;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    onResourceReady((Resource&lt;R&gt;) resource, (R) received, dataSource);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**参数安全的onResourceReady函数 */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(Resource&lt;R&gt; resource, R result, DataSource dataSource)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 设置状态之前，必须调用isFirstReadyResource。</span></span><br><span class="line">    <span class="keyword">boolean</span> isFirstResource = isFirstReadyResource();</span><br><span class="line">    status = Status.COMPLETE;</span><br><span class="line">    <span class="keyword">this</span>.resource = resource;</span><br><span class="line">    isCallingCallbacks = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//1.检查是否有RequestListener拦截请求</span></span><br><span class="line">      <span class="keyword">boolean</span> anyListenerHandledUpdatingTarget = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (requestListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (RequestListener&lt;R&gt; listener : requestListeners) &#123;</span><br><span class="line">          anyListenerHandledUpdatingTarget |=</span><br><span class="line">              listener.onResourceReady(result, model, target, dataSource, isFirstResource);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//2.检查是否有TargetListener拦截请求</span></span><br><span class="line">      anyListenerHandledUpdatingTarget |=</span><br><span class="line">          targetListener != <span class="keyword">null</span></span><br><span class="line">              &amp;&amp; targetListener.onResourceReady(result, model, target, dataSource, isFirstResource);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//3.没有拦截的情况下，调用target.onResourceReady()</span></span><br><span class="line">      <span class="keyword">if</span> (!anyListenerHandledUpdatingTarget) &#123;</span><br><span class="line">        Transition&lt;? <span class="keyword">super</span> R&gt; animation =</span><br><span class="line">            animationFactory.build(dataSource, isFirstResource);</span><br><span class="line">        target.onResourceReady(result, animation);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      isCallingCallbacks = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    notifyLoadSuccess();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SingleRequest的onResourceReady代码比较清晰，检查参数是否合法，并调用回调。在举例的情况下，<code>target.onResourceReady(result, animation);</code>调用的是<code>DrawableImageViewTarget#onResourceReady</code>。</p>
<h2 id="ImageViewTarget"><a href="#ImageViewTarget" class="headerlink" title="ImageViewTarget"></a>ImageViewTarget</h2><h3 id="onResourceReady-2"><a href="#onResourceReady-2" class="headerlink" title="#onResourceReady"></a>#onResourceReady</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 基于Target用于在ImageView中显示资源*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageViewTarget</span>&lt;<span class="title">Z</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResourceReady</span><span class="params">(@NonNull Z resource, @Nullable Transition&lt;? <span class="keyword">super</span> Z&gt; transition)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (transition == <span class="keyword">null</span> || !transition.transition(resource, <span class="keyword">this</span>)) &#123;</span><br><span class="line">      setResourceInternal(resource);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      maybeUpdateAnimatable(resource);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setResourceInternal</span><span class="params">(@Nullable Z resource)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 顺序在此很重要。首先得调用setResource确保非空</span></span><br><span class="line">    setResource(resource);</span><br><span class="line">    maybeUpdateAnimatable(resource);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DrawableImageViewTarget-setResource——显示图片"><a href="#DrawableImageViewTarget-setResource——显示图片" class="headerlink" title="DrawableImageViewTarget#setResource——显示图片"></a>DrawableImageViewTarget#setResource——显示图片</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 用于在ImageView中显示Drawable对象的Target类 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DrawableImageViewTarget</span> <span class="keyword">extends</span> <span class="title">ImageViewTarget</span>&lt;<span class="title">Drawable</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> Drawable view; <span class="comment">//来自父类的父类,这里是Drawable类型</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setResource</span><span class="params">(@Nullable Drawable resource)</span> </span>&#123;</span><br><span class="line">    view.setImageDrawable(resource);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自此，ImageView中正确地加载了网络上下载（或缓存）的图片。</p>
<h2 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h2><p>一个into方法里面暗含了如此多的逻辑，解读起来十分痛苦。现在重新梳理一下：</p>
<ol>
<li>ViewTarget&lt;&gt; RequestBuilder.into(ImageView imageView) 设置加载目标；</li>
<li>ImageViewTargetFactory 根据参数分配对应的 ViewTarget；</li>
<li>RequestBuilder 生成 SingleRequest，并在 RequestManager 中跟踪；</li>
<li>Engine 调度 EngineJob 来进行 Decode。</li>
<li>DecodeJob 根据当前状态处理逻辑：根据 SingleRequest 的 StringLoder 使用 HttpUrlFetcher 来载入资源；</li>
<li>根据资源来进行解码；</li>
<li>各层回调 onResourceReady 清理资源、进行缓存等操作。</li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>通过一个典型的Gilde.with().load().into()分析了Glide的整个加载流程，可以作出如下总结：</p>
<ol>
<li>单例模式：Glide通过单例模式来初始化配置；</li>
<li>生命周期感知：通过在视图上创建空的Fragment来感知界面的生命周期从而控制资源的加载与释放、请求的取消；</li>
<li>缓存：Glide以key的方式优先从ActiveResources中寻找资源，其次从MemoryCache中寻找资源，最后才使用磁盘资源或者网络资源进行加载。</li>
</ol>
<p>Glide源码比较复杂，基于目前版本的分析可能在数个更新后又会失去意义，所以一定要去了解其核心机制，切不可停留表面；同样地，由于其复杂且本人技术有限，在分析时难免出现遗漏和错误，欢迎斧正。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag"># 笔记</a>
          
            <a href="/tags/Glide/" rel="tag"># Glide</a>
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/06/09/server-client/" rel="next" title="从以太网服务分析Android的Server-Client架构">
                <i class="fa fa-chevron-left"></i> 从以太网服务分析Android的Server-Client架构
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Zapper</p>
              <p class="site-description motion-element" itemprop="description">Monsters are dangerous, and just now, kings are dying like flies.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives%7C%7C%20archive">
              
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="mailto:z@projectd.in" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          
            <div class="cc-license motion-element" itemprop="license">
              <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" class="cc-opacity" target="_blank">
                <img src="/images/cc-by-nc-nd.svg" alt="Creative Commons" />
              </a>
            </div>
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#总览"><span class="nav-number">1.</span> <span class="nav-text">总览</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#With"><span class="nav-number">2.</span> <span class="nav-text">With</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Glide"><span class="nav-number">2.1.</span> <span class="nav-text">Glide</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#with"><span class="nav-number">2.1.1.</span> <span class="nav-text">#with</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getRetriever"><span class="nav-number">2.1.2.</span> <span class="nav-text">#getRetriever</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#get——获取单例"><span class="nav-number">2.1.3.</span> <span class="nav-text">#get——获取单例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RequestManagerRetriever"><span class="nav-number">2.2.</span> <span class="nav-text">RequestManagerRetriever</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#get"><span class="nav-number">2.2.1.</span> <span class="nav-text">#get</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getApplicationManager"><span class="nav-number">2.2.2.</span> <span class="nav-text">#getApplicationManager</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RequestManagerFactory-build"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">#RequestManagerFactory#build</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fragmentGet"><span class="nav-number">2.2.3.</span> <span class="nav-text">#fragmentGet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getRequestManagerFragment"><span class="nav-number">2.2.4.</span> <span class="nav-text">#getRequestManagerFragment</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#handleMessage"><span class="nav-number">2.2.5.</span> <span class="nav-text">#handleMessage</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RequestManagerFragment——感知生命周期"><span class="nav-number">2.3.</span> <span class="nav-text">RequestManagerFragment——感知生命周期</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小结"><span class="nav-number">2.4.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Load"><span class="nav-number">3.</span> <span class="nav-text">Load</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RequestManager"><span class="nav-number">3.1.</span> <span class="nav-text">RequestManager</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#load"><span class="nav-number">3.1.1.</span> <span class="nav-text">#load</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#load-String"><span class="nav-number">3.1.1.1.</span> <span class="nav-text">#load(String)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#asDrawable"><span class="nav-number">3.1.1.1.1.</span> <span class="nav-text">#asDrawable</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#as"><span class="nav-number">3.1.1.1.1.1.</span> <span class="nav-text">#as</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RequestBuilder"><span class="nav-number">3.2.</span> <span class="nav-text">RequestBuilder</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#load-1"><span class="nav-number">3.2.1.</span> <span class="nav-text">#load</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#new"><span class="nav-number">3.2.2.</span> <span class="nav-text">#new</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#initRequestListeners"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">#initRequestListeners</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#apply"><span class="nav-number">3.2.2.2.</span> <span class="nav-text">#apply</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RequestManager-getDefaultTransitionOptions"><span class="nav-number">3.2.2.3.</span> <span class="nav-text">RequestManager#getDefaultTransitionOptions</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TransitionOptions——变换选项"><span class="nav-number">3.3.</span> <span class="nav-text">TransitionOptions——变换选项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小结-1"><span class="nav-number">3.4.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Into"><span class="nav-number">4.</span> <span class="nav-text">Into</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RequestBuilder-1"><span class="nav-number">4.1.</span> <span class="nav-text">RequestBuilder</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#into"><span class="nav-number">4.1.1.</span> <span class="nav-text">#into</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#GlideContext-buildImageViewTarget"><span class="nav-number">4.1.1.1.</span> <span class="nav-text">GlideContext#buildImageViewTarget</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#buildRequest"><span class="nav-number">4.1.2.</span> <span class="nav-text">#buildRequest</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#buildThumbnailRequestRecursive"><span class="nav-number">4.1.3.</span> <span class="nav-text">#buildThumbnailRequestRecursive</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SingleRequest"><span class="nav-number">4.2.</span> <span class="nav-text">SingleRequest</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#obtain"><span class="nav-number">4.2.1.</span> <span class="nav-text">#obtain</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FactoryPools"><span class="nav-number">4.3.</span> <span class="nav-text">FactoryPools</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#threadSafe"><span class="nav-number">4.3.1.</span> <span class="nav-text">#threadSafe</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RequestManager-1"><span class="nav-number">4.4.</span> <span class="nav-text">RequestManager</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#track"><span class="nav-number">4.4.1.</span> <span class="nav-text">#track</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SingleRequest-1"><span class="nav-number">4.5.</span> <span class="nav-text">SingleRequest</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#begin"><span class="nav-number">4.5.1.</span> <span class="nav-text">#begin</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#onSizeReady-onResourceReady"><span class="nav-number">4.5.2.</span> <span class="nav-text">#onSizeReady&#x2F;#onResourceReady</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Engine"><span class="nav-number">4.6.</span> <span class="nav-text">Engine</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#load——缓存策略"><span class="nav-number">4.6.1.</span> <span class="nav-text">#load——缓存策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EngineJob-start"><span class="nav-number">4.6.2.</span> <span class="nav-text">EngineJob#start</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DecodeJob"><span class="nav-number">4.7.</span> <span class="nav-text">DecodeJob</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#run"><span class="nav-number">4.7.1.</span> <span class="nav-text">#run</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#runWrapped"><span class="nav-number">4.7.2.</span> <span class="nav-text">#runWrapped</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SourceGenerator"><span class="nav-number">4.8.</span> <span class="nav-text">SourceGenerator</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#startNext"><span class="nav-number">4.8.1.</span> <span class="nav-text">#startNext</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DecoderHelper"><span class="nav-number">4.9.</span> <span class="nav-text">DecoderHelper</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#getLoadData"><span class="nav-number">4.9.1.</span> <span class="nav-text">#getLoadData</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ModelLoader"><span class="nav-number">4.10.</span> <span class="nav-text">ModelLoader</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#StringLoader"><span class="nav-number">4.10.1.</span> <span class="nav-text">StringLoader</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HttpUrlFetcher"><span class="nav-number">4.11.</span> <span class="nav-text">HttpUrlFetcher</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#loadDataWithRedirects——网络连接"><span class="nav-number">4.11.1.</span> <span class="nav-text">#loadDataWithRedirects——网络连接</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DecodeJob-1"><span class="nav-number">4.12.</span> <span class="nav-text">DecodeJob</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#decodeFromRetrievedData"><span class="nav-number">4.12.1.</span> <span class="nav-text">#decodeFromRetrievedData</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#notifyEncodeAndRelease"><span class="nav-number">4.12.2.</span> <span class="nav-text">#notifyEncodeAndRelease</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LoadPath"><span class="nav-number">4.13.</span> <span class="nav-text">LoadPath</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#load-2"><span class="nav-number">4.13.1.</span> <span class="nav-text">#load</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DecodePath"><span class="nav-number">4.14.</span> <span class="nav-text">DecodePath</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#decode"><span class="nav-number">4.14.1.</span> <span class="nav-text">#decode</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EngineJob"><span class="nav-number">4.15.</span> <span class="nav-text">EngineJob</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#onResourceReady"><span class="nav-number">4.15.1.</span> <span class="nav-text">#onResourceReady</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SingleRequest-2"><span class="nav-number">4.16.</span> <span class="nav-text">SingleRequest</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#onResourceReady-1"><span class="nav-number">4.16.1.</span> <span class="nav-text">#onResourceReady</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ImageViewTarget"><span class="nav-number">4.17.</span> <span class="nav-text">ImageViewTarget</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#onResourceReady-2"><span class="nav-number">4.17.1.</span> <span class="nav-text">#onResourceReady</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DrawableImageViewTarget-setResource——显示图片"><span class="nav-number">4.17.2.</span> <span class="nav-text">DrawableImageViewTarget#setResource——显示图片</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小结-2"><span class="nav-number">4.18.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zapper</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
